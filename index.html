<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SRC-D2 | Peace Operator [v3.7]</title>
<style>@import url('https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Michroma&display=swap');:root{--primary:#0ff;--secondary:#0f0;--silver:#e0ffff;--dark-bg:#050a19;--mid-bg:#1a2238;--critical:#f33;--warning:#ffd700;--orange-alert:#fb923c;--text-glow-primary:0 0 10px rgba(0,255,255,.8),0 0 20px rgba(0,255,255,.4);--border-glow-primary:0 0 8px #0ff,inset 0 0 8px rgba(0,255,255,.6);--text-glow-secondary:0 0 8px rgba(0,255,0,.8);--border-glow-yellow:0 0 8px rgba(255,215,0,.8),inset 0 0 5px rgba(255,215,0,.4);--border-glow-red:0 0 8px rgba(255,51,51,.8),inset 0 0 5px rgba(255,51,51,.4);--border-glow-green:0 0 8px rgba(0,255,0,.8),inset 0 0 5px rgba(0,255,0,.4);--midnight-purp-bg:#0f0518;--neon-pink:#f0f;--border-glow-pink:0 0 8px rgba(255,0,255,.8),inset 0 0 5px rgba(255,0,255,.4);--text-glow-pink:0 0 5px rgba(255,0,255,.8);--text-glow-red:0 0 10px rgba(255,51,51,.8),0 0 20px rgba(255,51,51,.5)}*,::after,::before{box-sizing:border-box;border-width:0;border-style:solid;border-color:#e5e7eb}html{line-height:1.5;-webkit-text-size-adjust:100%;font-family:ui-sans-serif,system-ui,sans-serif}body{margin:0;line-height:inherit}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;font-weight:inherit;line-height:inherit;color:inherit;margin:0;padding:0}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button;background-color:transparent;background-image:none}::-webkit-inner-spin-button,::-webkit-outer-spin-button{height:auto}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}summary{display:list-item}h1,h2,h3,h4,h5,h6,p,pre{margin:0}menu,ol,ul{list-style:none;margin:0;padding:0}textarea{resize:vertical}input::placeholder,textarea::placeholder{opacity:1;color:#9ca3af}[role=button],button{cursor:pointer}:disabled{cursor:default}audio,canvas,embed,iframe,img,object,svg,video{display:block;vertical-align:middle}img,video{max-width:100%;height:auto}[hidden]{display:none}body.ghost-mode{--primary:#c0c0c0;--secondary:grey;--silver:#666;--dark-bg:#000;--mid-bg:#0a0a0a;--critical:#8b0000;--warning:#a9a9a9;--orange-alert:#804000;--text-glow-primary:none;--border-glow-primary:none;--text-glow-secondary:none;--border-glow-yellow:none;--border-glow-red:none;--border-glow-green:none;--border-glow-pink:none;--text-glow-pink:none;--text-glow-red:none}body.ghost-mode *{text-shadow:none!important;box-shadow:none!important}body.ghost-mode .btn-midnight-purple,body.ghost-mode .glow-border-cyan,body.ghost-mode .glow-border-green,body.ghost-mode .glow-btn-green,body.ghost-mode .glow-btn-red,body.ghost-mode .glow-btn-yellow{border-color:#333;box-shadow:none;color:#888}body.ghost-mode .bg-dark-navy,body.ghost-mode .modal-content{background-color:#000!important;border-color:#333!important}body{font-family:'Space Mono',monospace;background-color:var(--dark-bg);color:var(--silver);height:100vh;overflow:hidden;transition:background-color .5s ease,color .5s ease}.glow-text-cyan,.neon-cyan{color:var(--primary);text-shadow:var(--text-glow-primary)}.neon-green{color:var(--secondary);text-shadow:var(--text-glow-secondary)}.bg-dark-navy{background-color:var(--dark-bg)}.bg-mid-blue{background-color:var(--mid-bg)}.glow-border-cyan{border:1px solid var(--primary);box-shadow:var(--border-glow-primary)}.glow-border-green{border:1px solid var(--secondary);box-shadow:var(--border-glow-green)}.glow-btn-yellow{border:1px solid var(--warning);box-shadow:var(--border-glow-yellow);color:#fff}.glow-btn-red{border:1px solid var(--critical);box-shadow:var(--border-glow-red);color:#fff}.glow-btn-green{border:1px solid var(--secondary);box-shadow:var(--border-glow-green);color:#fff}.panel-grid-bg{background-image:linear-gradient(rgba(0,255,255,.03) 1px,transparent 1px),linear-gradient(90deg,rgba(0,255,255,.03) 1px,transparent 1px);background-size:20px 20px}.glyph-btn{font-family:'Michroma',sans-serif;line-height:1;padding:4px 6px;transition:all .2s ease;background:0 0;border:none;cursor:pointer;border-radius:4px;white-space:nowrap}.glyph-btn:hover{transform:scale(1.1);background-color:rgba(255,255,255,.1);text-shadow:0 0 8px currentColor}.rune-close{text-shadow:var(--text-glow-red);transition:all .2s ease;cursor:pointer;z-index:100}.rune-close:hover{transform:scale(1.2);color:#f99}.btn-midnight-purple{background-color:var(--midnight-purp-bg);color:var(--neon-pink);border:1px solid var(--neon-pink);box-shadow:0 0 5px rgba(255,0,255,.2);transition:all .2s ease;font-family:'Michroma',sans-serif;letter-spacing:.5px;text-shadow:var(--text-glow-pink)}.btn-midnight-purple:hover{box-shadow:var(--border-glow-pink);background-color:#1a0b2e;transform:translateY(-1px)}.scanline-overlay::before{content:"";position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(to bottom,transparent 50%,rgba(0,0,0,.3) 50%);background-size:100% 4px;pointer-events:none;z-index:9999}.dashboard-container{height:100vh;display:flex;transition:all .3s ease}.left-pane,.right-pane{height:100%;overflow-y:auto;flex-shrink:0}::-webkit-scrollbar{width:6px}::-webkit-scrollbar-thumb{background-color:var(--secondary);border-radius:3px;box-shadow:0 0 5px var(--secondary)}::-webkit-scrollbar-track{background-color:var(--mid-bg)}@media (max-width:768px){.left-pane,.right-pane{position:absolute;width:100%;z-index:10}.dashboard-container.mobile-list-view .left-pane{transform:translateX(0);z-index:20}.dashboard-container.mobile-list-view .right-pane{transform:translateX(100%);z-index:10}.dashboard-container.mobile-detail-view .left-pane{transform:translateX(-100%);z-index:10}.dashboard-container.mobile-detail-view .right-pane{transform:translateX(0);z-index:20}}button:focus,input:focus,textarea:focus{outline:0;box-shadow:0 0 5px var(--primary)}.scratchpad-textarea{font-family:'Space Mono',monospace;line-height:1.4;tab-size:4;color:var(--secondary);background-color:rgba(26,34,56,.8)}.input-active{color:var(--secondary);text-shadow:0 0 5px rgba(0,255,0,.5)}.text-viewer{color:var(--primary);text-shadow:0 0 5px rgba(0,255,255,.5);background-color:#050a19}#adr-toast-container{position:fixed;bottom:20px;left:50%;transform:translateX(-50%);z-index:9999;pointer-events:none;display:flex;flex-direction:column-reverse;align-items:center;gap:10px}.adr-toast{background-color:rgba(26,34,56,.95);border-left:4px solid var(--secondary);color:var(--silver);padding:12px 16px;border-radius:4px;box-shadow:0 0 10px rgba(0,0,0,.5);font-size:.85rem;min-width:250px;transition:opacity .5s ease-in-out;opacity:0;text-align:center}.eq-band{position:relative;background-color:rgba(0,0,0,.3);border-right:1px solid rgba(255,255,255,.05);cursor:ns-resize}.eq-band:hover{background-color:rgba(255,255,255,.05)}.eq-led{width:100%;height:4px;background-color:#333;box-shadow:0 0 2px #000;transition:background-color .1s}.eq-led.active-red{background-color:#ef4444;box-shadow:0 0 8px #ef4444}.eq-led.active-green{background-color:#22c55e;box-shadow:0 0 8px #22c55e}.eq-fader-cap{position:absolute;left:0;width:100%;height:4px;background-color:var(--warning);box-shadow:0 0 5px var(--warning);pointer-events:none;z-index:10}.eq-signal-bar{position:absolute;bottom:0;left:0;width:100%;background-color:rgba(0,255,255,.3);pointer-events:none;transition:height .05s linear;z-index:5}.bg-black{background-color:#000}.bg-white{background-color:#fff}.bg-transparent{background-color:transparent}.text-white{color:#fff}.text-black{color:#000}.border-white{border-color:#fff}.bg-slate-600{background-color:#475569}.bg-slate-700{background-color:#334155}.bg-slate-800{background-color:#1e293b}.bg-gray-600{background-color:#4b5563}.bg-gray-700{background-color:#374151}.bg-gray-800{background-color:#1f2937}.bg-gray-900{background-color:#111827}.bg-red-500{background-color:#ef4444}.bg-red-600{background-color:#dc2626}.bg-red-700{background-color:#b91c1c}.bg-red-800{background-color:#991b1b}.bg-red-900{background-color:#7f1d1d}.bg-orange-500{background-color:#f97316}.bg-yellow-400{background-color:#facc15}.bg-yellow-700{background-color:#a16207}.bg-green-500{background-color:#22c55e}.bg-green-700{background-color:#15803d}.bg-green-800{background-color:#166534}.bg-cyan-500{background-color:#06b6d4}.bg-cyan-600{background-color:#0891b2}.bg-cyan-700{background-color:#0e7490}.bg-cyan-900{background-color:#164e63}.bg-purple-900{background-color:#581c87}.text-gray-300{color:#d1d5db}.text-gray-400{color:#9ca3af}.text-gray-500{color:#6b7280}.text-gray-600{color:#4b5563}.text-gray-700{color:#374151}.text-red-300{color:#fca5a5}.text-red-400{color:#f87171}.text-red-500{color:#ef4444}.text-yellow-200{color:#fef08a}.text-yellow-400{color:#facc15}.text-yellow-500{color:#eab308}.text-green-300{color:#86efac}.text-green-400{color:#4ade80}.text-green-500{color:#22c55e}.text-cyan-100{color:#cffafe}.text-cyan-200{color:#a5f3fc}.text-cyan-300{color:#67e8f9}.text-cyan-400{color:#22d3ee}.text-cyan-500{color:#06b6d4}.text-purple-400{color:#c084fc}.text-purple-500{color:#a855f7}.text-pink-400{color:#f472b6}.text-orange-400{color:#fb923c}.border-gray-500{border-color:#6b7280}.border-gray-600{border-color:#4b5563}.border-gray-700{border-color:#374151}.border-gray-800{border-color:#1f2937}.border-red-500{border-color:#ef4444}.border-red-900{border-color:#7f1d1d}.border-yellow-500{border-color:#eab308}.border-yellow-900{border-color:#713f12}.border-green-500{border-color:#22c55e}.border-green-900{border-color:#14532d}.border-cyan-500{border-color:#06b6d4}.border-cyan-900{border-color:#164e63}.border-purple-500{border-color:#a855f7}.border-orange-500{border-color:#f97316}.bg-black\/40{background-color:rgba(0,0,0,.4)}.bg-black\/50{background-color:rgba(0,0,0,.5)}.bg-black\/60{background-color:rgba(0,0,0,.6)}.bg-black\/80{background-color:rgba(0,0,0,.8)}.bg-black\/90{background-color:rgba(0,0,0,.9)}.bg-black\/95{background-color:rgba(0,0,0,.95)}.bg-cyan-900\/50{background-color:rgba(22,78,99,.5)}.bg-red-900\/10{background-color:rgba(127,29,29,.1)}.bg-red-900\/50{background-color:rgba(127,29,29,.5)}.bg-yellow-900\/20{background-color:rgba(113,63,18,.2)}.bg-yellow-900\/40{background-color:rgba(113,63,18,.4)}.border-cyan-500\/30{border-color:rgba(6,182,212,.3)}.border-cyan-500\/50{border-color:rgba(6,182,212,.5)}.border-cyan-900\/50{border-color:rgba(22,78,99,.5)}.border-green-500\/30{border-color:rgba(34,197,94,.3)}.border-yellow-500\/30{border-color:rgba(234,179,8,.3)}.border-yellow-500\/50{border-color:rgba(234,179,8,.5)}.border-red-500\/30{border-color:rgba(239,68,68,.3)}.border-red-500\/50{border-color:rgba(239,68,68,.5)}.border-red-900\/30{border-color:rgba(127,29,29,.3)}.border-purple-500\/30{border-color:rgba(168,85,247,.3)}.border-gray-700\/50{border-color:rgba(55,65,81,.5)}.border-gray-800\/50{border-color:rgba(31,41,55,.5)}.border-orange-500\/30{border-color:rgba(249,115,22,.3)}.text-cyan-500\/20{color:rgba(6,182,212,.2)}.text-cyan-500\/40{color:rgba(6,182,212,.4)}.text-purple-500\/20{color:rgba(168,85,247,.2)}.hover\:bg-cyan-600:hover{background-color:#0891b2}.hover\:bg-cyan-700:hover{background-color:#0e7490}.hover\:bg-cyan-900\/50:hover{background-color:rgba(22,78,99,.5)}.hover\:bg-slate-600:hover{background-color:#475569}.hover\:bg-slate-700:hover{background-color:#334155}.hover\:bg-red-600:hover{background-color:#dc2626}.hover\:bg-red-700:hover{background-color:#b91c1c}.hover\:bg-red-800:hover{background-color:#991b1b}.hover\:bg-red-900\/20:hover{background-color:rgba(127,29,29,.2)}.hover\:bg-green-600:hover{background-color:#16a34a}.hover\:bg-green-700:hover{background-color:#15803d}.hover\:bg-green-900:hover{background-color:#14532d}.hover\:bg-yellow-600:hover{background-color:#ca8a04}.hover\:bg-yellow-900\/20:hover{background-color:rgba(113,63,18,.2)}.hover\:bg-yellow-900\/50:hover{background-color:rgba(113,63,18,.5)}.hover\:bg-purple-900:hover{background-color:#581c87}.hover\:bg-orange-900\/50:hover{background-color:rgba(124,45,18,.5)}.hover\:text-white:hover{color:#fff}.hover\:text-cyan-200:hover{color:#a5f3fc}.hover\:text-yellow-200:hover{color:#fef08a}.hover\:text-red-200:hover{color:#fecaca}.hover\:opacity-100:hover{opacity:1}.focus\:border-cyan-500:focus{border-color:#06b6d4}.focus\:border-green-500:focus{border-color:#22c55e}.focus\:border-yellow-500:focus{border-color:#eab308}.focus\:outline-none:focus{outline:2px solid transparent;outline-offset:2px}.focus\:shadow-\[0_0_10px_rgba\(0\,255\,255\,0\.3\)\]:focus{box-shadow:0 0 10px rgba(0,255,255,.3)}.flex{display:flex}.flex-col{flex-direction:column}.flex-row{flex-direction:row}.flex-col-reverse{flex-direction:column-reverse}.grid{display:grid}.grid-cols-1{grid-template-columns:repeat(1,minmax(0,1fr))}.grid-cols-2{grid-template-columns:repeat(2,minmax(0,1fr))}.col-span-2{grid-column:span 2/span 2}.hidden{display:none}.block{display:block}.inline-block{display:inline-block}.fixed{position:fixed}.absolute{position:absolute}.relative{position:relative}.inset-0{top:0;right:0;bottom:0;left:0}.top-0{top:0}.left-0{left:0}.right-0{right:0}.bottom-0{bottom:0}.top-2{top:.5rem}.right-2{right:.5rem}.top-3{top:.75rem}.right-4{right:1rem}.top-5{top:1.25rem}.right-5{right:1.25rem}.bottom-4{bottom:1rem}.left-4{left:1rem}.bottom-20{bottom:5rem}.left-50\%{left:50%}.z-10{z-index:10}.z-20{z-index:20}.z-30{z-index:30}.z-40{z-index:40}.z-50{z-index:50}.z-\[60\]{z-index:60}.z-\[70\]{z-index:70}.z-\[75\]{z-index:75}.z-\[80\]{z-index:80}.z-\[90\]{z-index:90}.z-\[100\]{z-index:100}.z-9999{z-index:9999}.w-full{width:100%}.w-11\/12{width:91.666667%}.w-96{width:24rem}.w-10{width:2.5rem}.w-14{width:3.5rem}.w-8{width:2rem}.w-2{width:.5rem}.w-4{width:1rem}.w-6{width:1.5rem}.w-12{width:3rem}.w-16{width:4rem}.w-0{width:0}.h-full{height:100%}.h-screen{height:100vh}.h-10{height:2.5rem}.h-14{height:3.5rem}.h-8{height:2rem}.h-2{height:.5rem}.h-64{height:16rem}.h-24{height:6rem}.h-20{height:5rem}.h-32{height:8rem}.h-1{height:.25rem}.h-\[90vh\]{height:90vh}.h-\[45vh\]{height:45vh}.h-\[55vh\]{height:55vh}.h-\[2px\]{height:2px}.h-3\/4{height:75%}.h-5\/6{height:83.333333%}.min-w-0{min-width:0}.min-w-\[250px\]{min-width:250px}.max-w-md{max-width:28rem}.max-w-2xl{max-width:42rem}.max-h-\[90vh\]{max-height:90vh}.max-w-full{max-width:100%}.max-h-full{max-height:100%}.p-4{padding:1rem}.p-2{padding:.5rem}.p-6{padding:1.5rem}.p-3{padding:.75rem}.p-1{padding:.25rem}.p-0\.5{padding:.125rem}.px-2{padding-left:.5rem;padding-right:.5rem}.px-3{padding-left:.75rem;padding-right:.75rem}.px-4{padding-left:1rem;padding-right:1rem}.py-0\.5{padding-top:.125rem;padding-bottom:.125rem}.py-1{padding-top:.25rem;padding-bottom:.25rem}.py-2{padding-top:.5rem;padding-bottom:.5rem}.py-3{padding-top:.75rem;padding-bottom:.75rem}.pb-2{padding-bottom:.5rem}.pb-1{padding-bottom:.25rem}.pb-24{padding-bottom:6rem}.pr-4{padding-right:1rem}.pr-10{padding-right:2.5rem}.pr-2{padding-right:.5rem}.pl-1{padding-left:.25rem}.pt-2{padding-top:.5rem}.m-0{margin:0}.mt-6{margin-top:1.5rem}.mb-3{margin-bottom:.75rem}.mb-4{margin-bottom:1rem}.mb-6{margin-bottom:1.5rem}.mb-8{margin-bottom:2rem}.mb-2{margin-bottom:.5rem}.mb-1{margin-bottom:.25rem}.mt-1{margin-top:.25rem}.mt-2{margin-top:.5rem}.mt-4{margin-top:1rem}.mx-2{margin-left:.5rem;margin-right:.5rem}.mx-0\.5{margin-left:.125rem;margin-right:.125rem}.gap-2{gap:.5rem}.gap-4{gap:1rem}.gap-1{gap:.25rem}.gap-3{gap:.75rem}.gap-px{gap:1px}.space-y-2>:not([hidden])~:not([hidden]){margin-top:.5rem}.space-y-3>:not([hidden])~:not([hidden]){margin-top:.75rem}.space-y-1>:not([hidden])~:not([hidden]){margin-top:.25rem}.space-x-2>:not([hidden])~:not([hidden]){margin-left:.5rem}.space-x-3>:not([hidden])~:not([hidden]){margin-left:.75rem}.justify-between{justify-content:space-between}.justify-center{justify-content:center}.justify-end{justify-content:flex-end}.items-center{align-items:center}.items-end{align-items:flex-end}.items-start{align-items:flex-start}.flex-shrink-0{flex-shrink:0}.flex-grow{flex-grow:1}.order-1{order:1}.order-2{order:2}.overflow-hidden{overflow:hidden}.overflow-y-auto{overflow-y:auto}.resize-none{resize:none}.cursor-pointer{cursor:pointer}.pointer-events-none{pointer-events:none}.transform{transform:translate(var(--tw-translate-x),var(--tw-translate-y)) rotate(var(--tw-rotate)) skewX(var(--tw-skew-x)) skewY(var(--tw-skew-y)) scaleX(var(--tw-scale-x)) scaleY(var(--tw-scale-y))}.translate-x-0{--tw-translate-x:0px}.translate-x-100\%{--tw-translate-x:100%}.translate-x-\(-100\%\){--tw-translate-x:-100%}.translate-x-\(-50\%\){--tw-translate-x:-50%}.translate-y-\(-1px\){--tw-translate-y:-1px}.scale-110{--tw-scale-x:1.1;--tw-scale-y:1.1}.scale-120{--tw-scale-x:1.2;--tw-scale-y:1.2}.transition{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke,opacity,box-shadow,transform,filter,backdrop-filter;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-all{transition-property:all;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-opacity{transition-property:opacity;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.transition-colors{transition-property:color,background-color,border-color,text-decoration-color,fill,stroke;transition-timing-function:cubic-bezier(.4,0,.2,1);transition-duration:.15s}.duration-75{transition-duration:75ms}.duration-100{transition-duration:.1s}.duration-300{transition-duration:.3s}.duration-500{transition-duration:.5s}.ease-in-out{transition-timing-function:cubic-bezier(.4,0,.2,1)}.backdrop-blur-sm{backdrop-filter:blur(4px)}.backdrop-blur-md{backdrop-filter:blur(12px)}.animate-pulse{animation:pulse 2s cubic-bezier(.4,0,.6,1) infinite}@keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}.appearance-none{-webkit-appearance:none;appearance:none}.outline-none{outline:2px solid transparent;outline-offset:2px}.font-bold{font-weight:700}.font-mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}.font-\[\'Michroma\'\]{font-family:'Michroma',sans-serif}.font-\[\'Space_Mono\'\]{font-family:'Space Mono',monospace}.text-xs{font-size:.75rem;line-height:1rem}.text-sm{font-size:.875rem;line-height:1.25rem}.text-lg{font-size:1.125rem;line-height:1.75rem}.text-xl{font-size:1.25rem;line-height:1.75rem}.text-2xl{font-size:1.5rem;line-height:2rem}.text-3xl{font-size:1.875rem;line-height:2.25rem}.text-4xl{font-size:2.25rem;line-height:2.5rem}.text-6xl{font-size:3.75rem;line-height:1}.text-\[8px\]{font-size:8px}.text-\[9px\]{font-size:9px}.text-\[10px\]{font-size:10px}.leading-tight{line-height:1.25}.leading-1{line-height:1}.leading-1\.4{line-height:1.4}.tracking-widest{letter-spacing:.1em}.tracking-\[0\.5em\]{letter-spacing:.5em}.uppercase{text-transform:uppercase}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.whitespace-nowrap{white-space:nowrap}.whitespace-pre-wrap{white-space:pre-wrap}.text-center{text-align:center}.text-right{text-align:right}.text-left{text-align:left}.border{border-width:1px}.border-2{border-width:2px}.border-t{border-top-width:1px}.border-b{border-bottom-width:1px}.border-l{border-left-width:1px}.border-r{border-right-width:1px}.border-x-2{border-left-width:2px;border-right-width:2px}.border-b-2{border-bottom-width:2px}.border-l-2{border-left-width:2px}.border-l-4{border-left-width:4px}.border-r-2{border-right-width:2px}.border-dashed{border-style:dashed}.border-none{border-style:none}.rounded{border-radius:.25rem}.rounded-lg{border-radius:.5rem}.rounded-full{border-radius:9999px}.rounded-none{border-radius:0}.rounded-b-lg{border-bottom-right-radius:.5rem;border-bottom-left-radius:.5rem}.shadow-lg{box-shadow:0 10px 15px -3px rgba(0,0,0,.1),0 4px 6px -2px rgba(0,0,0,.05)}.shadow-xl{box-shadow:0 20px 25px -5px rgba(0,0,0,.1),0 10px 10px -5px rgba(0,0,0,.04)}.shadow-md{box-shadow:0 4px 6px -1px rgba(0,0,0,.1),0 2px 4px -1px rgba(0,0,0,.06)}.shadow-\[0_0_30px_rgba\(0\,255\,255\,0\.2\)\]{box-shadow:0 0 30px rgba(0,255,255,.2)}.shadow-\[0_0_30px_rgba\(0\,255\,0\,0\.15\)\]{box-shadow:0 0 30px rgba(0,255,0,.15)}.shadow-\[0_0_30px_rgba\(255\,215\,0\,0\.15\)\]{box-shadow:0 0 30px rgba(255,215,0,.15)}.shadow-\[0_0_50px_rgba\(0\,255\,255\,0\.15\)\]{box-shadow:0 0 50px rgba(0,255,255,.15)}.shadow-\[0_0_50px_rgba\(0\,255\,255\,0\.1\)\]{box-shadow:0 0 50px rgba(0,255,255,.1)}.shadow-\[0_0_10px_rgba\(0\,0\,0\,0\.5\)\]{box-shadow:0 0 10px rgba(0,0,0,.5)}.shadow-\[0_0_10px_rgba\(255\,215\,0\,0\.2\)\]{box-shadow:0 0 10px rgba(255,215,0,.2)}.shadow-\[0_0_15px_rgba\(0\,255\,255\,0\.2\)\]{box-shadow:0 0 15px rgba(0,255,255,.2)}.shadow-\[0_0_15px_red\]{box-shadow:0 0 15px red}.shadow-\[0_0_5px_currentColor\]{box-shadow:0 0 5px currentColor}.shadow-\[0_0_5px_white\]{box-shadow:0 0 5px white}.shadow-\[0_-10px_20px_rgba\(0\,0\,0\,0\.5\)\]{box-shadow:0 -10px 20px rgba(0,0,0,.5)}.shadow-red-500\/30{--tw-shadow-color:rgba(239,68,68,.3);--tw-shadow:var(--tw-shadow-colored)}.shadow-cyan-500\/30{--tw-shadow-color:rgba(6,182,212,.3);--tw-shadow:var(--tw-shadow-colored)}.drop-shadow-\[0_0_10px_rgba\(0\,255\,255\,0\.8\)\]{filter:drop-shadow(0 0 10px rgba(0,255,255,.8))}.drop-shadow-md{filter:drop-shadow(0 4px 3px rgb(0 0 0 / 0.07)) drop-shadow(0 2px 2px rgb(0 0 0 / 0.06))}.bg-gradient-to-t{background-image:linear-gradient(to top,var(--tw-gradient-stops))}.bg-gradient-to-r{background-image:linear-gradient(to right,var(--tw-gradient-stops))}.from-green-500{--tw-gradient-from:#22c55e;--tw-gradient-to:rgb(34 197 94 / 0);--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}.via-yellow-400{--tw-gradient-to:rgb(250 204 21 / 0);--tw-gradient-stops:var(--tw-gradient-from),#facc15,var(--tw-gradient-to)}.to-red-500{--tw-gradient-to:#ef4444}.from-purple-500{--tw-gradient-from:#a855f7;--tw-gradient-to:rgb(168 85 247 / 0);--tw-gradient-stops:var(--tw-gradient-from),var(--tw-gradient-to)}.to-pink-500{--tw-gradient-to:#ec4899}.bg-\[linear-gradient\(rgba\(18\,16\,16\,0\)_50\%_rgba\(0\,0\,0\,0\.25\)_50\%\)\,linear-gradient\(90deg\,rgba\(255\,0\,0\,0\.06\)\,rgba\(0\,255\,0\,0\.02\)\,rgba\(0\,0\,255\,0\.06\)\)\]{background-image:linear-gradient(rgba(18,16,16,0) 50%,rgba(0,0,0,0.25) 50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))}.bg-\[length\:100\%_2px\,3px_100\%\]{background-size:100% 2px,3px 100%}@media (min-width:768px){.md\:w-1\/3{width:33.333333%}.md\:w-2\/3{width:66.666667%}.md\:w-1\/2{width:50%}.md\:w-3\/4{width:75%}.md\:w-5\/6{width:83.333333%}.md\:h-5\/6{height:83.333333%}.md\:h-full{height:100%}.md\:h-\[90vh\]{height:90vh}.md\:flex-row{flex-direction:row}.md\:grid-cols-3{grid-template-columns:repeat(3,minmax(0,1fr))}.md\:col-span-2{grid-column:span 2/span 2}.md\:order-1{order:1}.md\:order-2{order:2}.md\:border-t-0{border-top-width:0}.md\:border-r{border-right-width:1px}.md\:rounded-xl{border-radius:.75rem}.md\:border-2{border-width:2px}.md\:shadow-\[0_0_50px_rgba\(0\,255\,255\,0\.1\)\]{box-shadow:0 0 50px rgba(0,255,255,.1)}.md\:text-\[10px\]{font-size:10px}.md\:text-lg{font-size:1.125rem;line-height:1.75rem}.md\:w-\[95vw\]{width:95vw}.md\:h-\[90vh\]{height:90vh}}</style>
</head>
<body class="scanline-overlay">

    <div id="dashboard-container" class="dashboard-container bg-dark-navy">
        <!-- LEFT PANE -->
        <div id="left-pane" class="left-pane w-full md:w-1/3 p-4 border-r-2 border-r-cyan-500 glow-border-cyan">
            
            <!-- HEADER -->
            <header class="mb-4 flex justify-between items-center">
                <button id="ghost-mode-btn" class="glyph-btn text-xl text-gray-500 hover:text-white" title="Ghost Mode (Shadow Wolf)">Ø</button>
                <h1 class="text-2xl font-['Michroma'] glow-text-cyan text-right">SRC-D2 > STATUS</h1>
            </header>

            <!-- CONTROL DECK (THE SANDWICH) -->
            <div id="summary" class="mb-6 p-2 bg-mid-blue rounded-lg glow-border-cyan flex justify-between items-center">
                
                <!-- Left Column: Stacked Info -->
                <div class="flex flex-col justify-between h-full gap-2">
                    <!-- Top: Label -->
                    <p class="neon-cyan text-[10px] font-bold tracking-widest">METRICS_SUMMARY.LOG</p>
                    
                    <!-- Middle: Predator Glyphs -->
                    <div class="flex items-center gap-4">
                        <div class="flex items-center gap-2">
                            <button id="deck-new-project" class="glyph-btn text-xl text-cyan-400 border border-cyan-500/30 rounded px-2 hover:bg-cyan-900/50" title="New Project">ᛈ</button>
                            <span id="project-count" class="neon-green font-mono text-lg">0</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="deck-new-incident" class="glyph-btn text-xl text-orange-400 border border-orange-500/30 rounded px-2 hover:bg-orange-900/50" title="New Incident">ᚦ</button>
                            <span id="incident-count" class="neon-green font-mono text-lg">0</span>
                        </div>
                    </div>

                    <!-- Bottom: Status -->
                    <span id="net-status-text" class="text-[10px] font-mono text-gray-500">[ LINK: OFFLINE ]</span>
                </div>

                <!-- Right Column: Triangle Formation -->
                <div class="grid grid-cols-2 gap-1 text-xs">
                    <button id="deck-scratchpad" class="col-span-2 text-center glyph-btn text-cyan-400 hover:text-white text-lg" title="Toggle Scratchpad">ᛝ</button>
                    <button id="deck-import" class="glyph-btn text-green-400 hover:text-white text-lg" title="Import Data">⤓</button>
                    <button id="deck-export" class="glyph-btn text-yellow-400 hover:text-white text-lg" title="Export Data">⤒</button>
                </div>
            </div>

            <input type="file" id="import-file-input" class="hidden" accept=".srcd, *">

            <h2 class="text-xl neon-cyan mt-6 mb-3 font-['Michroma']">PROJECTS [P]</h2>
            <div id="project-list" class="space-y-2 mb-8"></div>

            <h2 class="text-xl neon-green mt-6 mb-3 font-['Michroma']">INCIDENTS [I]</h2>
            <div id="incident-list" class="space-y-2"></div>
        </div>

        <!-- RIGHT PANE -->
        <div id="right-pane" class="right-pane w-full md:w-2/3 p-4">
            <div id="detail-view" class="h-full">
                <div id="detail-empty" class="h-full flex flex-col justify-center items-center text-center p-8">
                    <span class="text-6xl mb-4 neon-cyan opacity-50 font-['Michroma']">SRC-D2 V1.0</span>
                    <p class="text-lg neon-cyan">SELECT AN ENTRY OR INITIATE NEW PROTOCOL.</p>
                    <p class="text-sm mt-2 opacity-70">DATA PERSISTENCE: LOCAL CACHE + INDEXEDDB</p>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL: SCRATCHPAD -->
    <div id="scratchpad-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm transition-opacity">
        <div class="modal-content bg-dark-navy p-6 w-11/12 md:w-3/4 h-[90vh] rounded-lg glow-border-cyan flex flex-col overflow-hidden">
            <h2 class="text-2xl font-['Michroma'] neon-cyan mb-4 flex-shrink-0">SCRATCHPAD > EPHEMERAL CONTEXT ENGINE</h2>
            <div id="scratchpad-tabs" class="flex border-b border-cyan-500 mb-0 flex-shrink-0">
                <button data-tab="main" class="scratchpad-tab-btn p-2 text-sm font-bold border-r border-cyan-500 active-tab">MAIN</button>
                <button data-tab="code" class="scratchpad-tab-btn p-2 text-sm font-bold border-r border-cyan-500 opacity-70 hover:opacity-100">CODE</button>
                <button data-tab="vip" class="scratchpad-tab-btn p-2 text-sm font-bold border-r border-cyan-500 opacity-70 hover:opacity-100">VIP_CONTEXT</button>
                <span class="flex-grow"></span>
            </div>
            <div id="scratchpad-content-container" class="flex-grow relative w-full h-full min-h-0 bg-transparent">
                <textarea id="scratchpad-main" data-tab="main" class="scratchpad-textarea w-full h-full p-3 text-sm rounded-none resize-none border-x-2 border-dashed border-cyan-500/50 focus:border-cyan-500" placeholder="Type large-scale thoughts, drafts, or inline HTML code here..."></textarea>
                <textarea id="scratchpad-code" data-tab="code" class="scratchpad-textarea w-full h-full p-3 text-sm rounded-none resize-none border-x-2 border-dashed border-green-500/50 absolute top-0 left-0 hidden focus:border-green-500" placeholder="Paste and sort code snippets, AI outputs, or technical documentation here."></textarea>
                <textarea id="scratchpad-vip" data-tab="vip" class="scratchpad-textarea w-full h-full p-3 text-sm rounded-none resize-none border-x-2 border-dashed border-yellow-500/50 absolute top-0 left-0 hidden focus:border-yellow-500" placeholder="Reserved space for mission-critical context or polished responses."></textarea>
                <span class="absolute top-2 right-4 text-xs opacity-50 neon-green pointer-events-none">Autosaved</span>
            </div>
            <div class="flex justify-between items-center px-3 py-1 bg-black/40 border-x-2 border-b-2 border-dashed border-gray-700/50 rounded-b-lg mb-3 flex-shrink-0 h-10 w-full">
                <div class="text-[10px] font-['Space_Mono'] text-gray-500 flex space-x-3 items-center">
                    <span>LINES: <span id="sp-lines" class="text-cyan-400">0</span></span>
                    <span class="text-gray-700">|</span>
                    <span>CHARS: <span id="sp-chars" class="text-cyan-400">0</span></span>
                </div>
                <button id="scratchpad-analyze-btn" class="btn-midnight-purple py-0.5 px-3 text-[10px] rounded uppercase flex items-center gap-2" title="Compare MAIN vs CODE HTML IDs"><span>[ ? ] ANALYZE IDs</span></button>
            </div>
            <div class="flex justify-end space-x-2 flex-shrink-0">
                <button id="scratchpad-preview-btn" class="py-1 px-3 text-xs rounded-lg bg-cyan-700 hover:bg-cyan-600 glow-border-cyan">[ </> ] PREVIEW HTML</button>
                <button id="scratchpad-export-btn" class="py-1 px-3 text-xs rounded-lg bg-slate-700 hover:bg-slate-600 glow-border-cyan">[ < ] SAVE AS .srcd</button>
                <button id="scratchpad-clear-btn" class="py-1 px-3 text-xs rounded-lg bg-red-700 hover:bg-red-600 glow-border-cyan">[ X ] CLEAR CONTEXT</button>
                <button id="scratchpad-close-btn" class="py-1 px-3 text-xs rounded-lg bg-slate-800 hover:bg-slate-700 glow-border-cyan">[ > ] CLOSE</button>
            </div>
        </div>
    </div>

    <!-- MODAL: ANALYZER -->
    <div id="analyzer-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-90 backdrop-blur-md transition-opacity">
        <div class="modal-content relative bg-dark-navy p-6 w-11/12 md:w-2/3 h-3/4 rounded-lg glow-border-cyan flex flex-col shadow-[0_0_30px_rgba(0,255,255,0.2)]">
            <div class="flex items-center mb-4 border-b border-cyan-500 pb-2 pr-10">
                <h2 class="text-2xl font-['Michroma'] neon-cyan glow-text-cyan">ID ANALYZER > REGRESSION CHECK</h2>
            </div>
            <button id="analyzer-close-btn" class="absolute top-5 right-5 text-red-500 rune-close text-2xl font-bold cursor-pointer bg-transparent border-none outline-none z-50" title="Close Overlay">✖</button>
            <div id="analyzer-result-container" class="flex-grow flex flex-col overflow-hidden gap-2">
                <div id="analyzer-status" class="text-lg font-bold font-['Michroma']"></div>
                <textarea id="analyzer-output" class="flex-grow w-full p-4 bg-black/40 border border-cyan-500/30 rounded text-cyan-200 font-['Space_Mono'] text-xs resize-none focus:outline-none focus:border-cyan-500" readonly></textarea>
            </div>
            <div class="flex justify-end mt-4">
                <button id="analyzer-copy-btn" class="py-2 px-4 text-xs font-bold rounded-lg bg-slate-800 border border-cyan-500 text-cyan-300 hover:bg-cyan-700 hover:text-white transition-all">[ COPY REPORT TO CLIPBOARD ]</button>
            </div>
        </div>
    </div>

    <!-- MODAL: DATA INPUT -->
    <div id="data-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-80 backdrop-blur-sm transition-opacity">
        <form id="data-form" class="modal-content bg-dark-navy p-6 w-11/12 md:w-1/2 rounded-lg glow-border-cyan flex flex-col">
            <h2 id="data-modal-title" class="text-2xl font-['Michroma'] neon-cyan mb-4">NEW ENTRY > PROJECT</h2>
            <input type="hidden" id="data-id" name="id">
            <input type="hidden" id="data-type" name="type">
            <label for="data-title" class="neon-cyan text-xs mb-1">TITLE (REQUIRED):</label>
            <input type="text" id="data-title" name="title" required class="input-active w-full mb-3 p-2 bg-mid-blue border border-cyan-500 rounded-lg text-sm">
            <div class="grid grid-cols-2 gap-3">
                <div>
                    <label for="data-status" class="neon-green text-xs mb-1">STATUS:</label>
                    <select id="data-status" name="status" class="input-active w-full mb-3 p-2 bg-mid-blue border border-green-500 rounded-lg text-sm">
                        <option value="Active">Active</option>
                        <option value="Pending">Pending</option>
                        <option value="Resolved">Resolved</option>
                        <option value="Archived">Archived</option>
                    </select>
                </div>
                <div>
                    <label for="data-due-date" class="neon-cyan text-xs mb-1">DUE DATE (YYYY-MM-DD):</label>
                    <input type="date" id="data-due-date" name="dueDate" class="input-active w-full mb-3 p-2 bg-mid-blue border border-cyan-500 rounded-lg text-sm">
                </div>
            </div>
            <div id="incident-fields" class="hidden grid grid-cols-2 gap-3">
                <div>
                    <label for="data-owner" class="neon-green text-xs mb-1">OWNER/CONTACT:</label>
                    <input type="text" id="data-owner" name="owner" class="input-active w-full mb-3 p-2 bg-mid-blue border border-green-500 rounded-lg text-sm" placeholder="Entity or Contact Name">
                </div>
                <div>
                    <label for="data-number" class="neon-green text-xs mb-1">INCIDENT NUMBER:</label>
                    <input type="text" id="data-number" name="number" class="input-active w-full mb-3 p-2 bg-mid-blue border border-green-500 rounded-lg text-sm" placeholder="Case Number / ID">
                </div>
            </div>
            <label for="data-notes" class="neon-cyan text-xs mb-1">NOTES/SUMMARY:</label>
            <textarea id="data-notes" name="notes" rows="6" class="input-active w-full mb-4 p-2 bg-mid-blue border border-cyan-500 rounded-lg text-sm"></textarea>
            <div class="flex justify-end space-x-2">
                <button type="button" id="data-cancel-btn" class="p-2 text-xs rounded-lg bg-slate-700 hover:bg-slate-600">[ X ] CANCEL</button>
                <button type="submit" class="p-2 text-xs rounded-lg bg-green-700 hover:bg-green-600 glow-border-cyan">[ ✓ ] SAVE ENTRY</button>
            </div>
        </form>
    </div>

    <!-- MODAL: CONFIRMATION -->
    <div id="notification-modal" class="hidden fixed inset-0 z-[70] flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm transition-opacity">
        <div class="modal-content bg-mid-blue p-6 w-96 rounded-lg border border-red-500 shadow-xl shadow-red-500/30">
            <h3 id="notification-title" class="text-lg font-bold mb-3 text-red-400">ALERT</h3>
            <p id="notification-message" class="text-sm mb-4"></p>
            <div id="notification-actions" class="flex justify-end space-x-2">
                <button id="notification-cancel" class="hidden p-2 text-xs rounded-lg bg-slate-700 hover:bg-slate-600">CANCEL</button>
                <button id="notification-confirm" class="p-2 text-xs rounded-lg bg-cyan-700 hover:bg-cyan-600">OK</button>
            </div>
        </div>
    </div>

    <!-- MODAL: ATTACHMENT LABEL -->
    <div id="attachment-label-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm transition-opacity">
        <form id="attachment-label-form" class="modal-content bg-mid-blue p-6 w-96 rounded-lg border border-cyan-500 shadow-xl shadow-cyan-500/30">
            <h3 class="text-lg font-bold mb-3 neon-cyan">ATTACHMENT CONTEXT</h3>
            <p class="text-sm mb-4">Provide a short label for the attached file (used for tooltip):</p>
            <input type="text" id="attachment-label-input" required class="input-active w-full mb-4 p-2 bg-dark-navy border border-cyan-500 rounded-lg text-sm" placeholder="e.g., 'Initial Threat Report'">
            <div class="flex justify-end space-x-2">
                <button type="button" id="attachment-label-cancel" class="p-2 text-xs rounded-lg bg-slate-700 hover:bg-slate-600">CANCEL</button>
                <button type="submit" class="p-2 text-xs rounded-lg bg-green-700 hover:bg-green-600 glow-border-cyan">ATTACH &amp; SAVE</button>
            </div>
        </form>
    </div>

    <!-- MODAL: ATTACHMENT EDIT -->
    <div id="attachment-edit-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm transition-opacity">
        <form id="attachment-edit-form" class="modal-content bg-mid-blue p-6 w-96 rounded-lg border border-cyan-500 shadow-xl shadow-cyan-500/30">
            <h3 class="text-lg font-bold mb-3 neon-cyan">EDIT ATTACHMENT CONTEXT</h3>
            <input type="hidden" id="edit-item-id">
            <input type="hidden" id="edit-item-type">
            <input type="hidden" id="edit-att-index">
            <label for="attachment-edit-label-input" class="neon-cyan text-xs mb-1">LABEL:</label>
            <input type="text" id="attachment-edit-label-input" required class="input-active w-full mb-4 p-2 bg-dark-navy border border-cyan-500 rounded-lg text-sm">
            <div class="flex justify-end space-x-2">
                <button type="button" id="attachment-edit-cancel" class="p-2 text-xs rounded-lg bg-slate-700 hover:bg-slate-600">CANCEL</button>
                <button type="submit" class="p-2 text-xs rounded-lg bg-green-700 hover:bg-green-600 glow-border-cyan">SAVE LABEL</button>
            </div>
        </form>
    </div>

    <!-- MODAL: RAW VIEW -->
    <div id="raw-view-modal" class="hidden fixed inset-0 z-[80] flex items-center justify-center bg-black bg-opacity-90 backdrop-blur-md transition-opacity">
        <div class="modal-content relative bg-dark-navy p-6 w-11/12 md:w-3/4 h-5/6 rounded-lg glow-border-cyan flex flex-col">
            <div class="flex justify-between items-center mb-4 border-b border-cyan-500 pb-2 pr-10">
                <h2 id="raw-view-title" class="text-2xl font-['Michroma'] neon-cyan glow-text-cyan">CONTENT VIEWER</h2>
                <button id="viewer-copy-btn" class="glyph-btn text-cyan-400 hover:text-white" title="Copy All Content">❐</button>
            </div>
            <button id="raw-view-close-btn" class="absolute top-5 right-5 text-cyan-500 rune-close text-2xl font-bold cursor-pointer bg-transparent border-none outline-none z-[90]">✖</button>
            <div class="flex-grow relative mb-4 overflow-y-auto">
                <div id="media-view-area" class="w-full h-full p-3 bg-mid-blue rounded-lg text-sm flex items-center justify-center hidden"></div>
                <textarea id="raw-view-textarea" class="text-viewer w-full h-full p-3 text-sm rounded-lg resize-none border-2 border-dashed border-cyan-500/50 font-['Space_Mono']" readonly></textarea>
            </div>
        </div>
    </div>

    <!-- MODAL: PREVIEW -->
    <div id="preview-modal" class="hidden fixed inset-0 z-[75] flex items-center justify-center bg-black bg-opacity-90 backdrop-blur-md transition-opacity">
        <div class="modal-content relative bg-dark-navy p-4 w-full h-full md:w-5/6 md:h-5/6 rounded-lg glow-border-cyan flex flex-col">
            <div class="flex justify-between items-center mb-2 border-b border-cyan-500 pb-2">
                <h2 class="text-xl font-['Michroma'] neon-cyan">HTML PREVIEW</h2>
                <button id="preview-close-btn" class="text-red-500 rune-close text-2xl font-bold cursor-pointer bg-transparent border-none">✖</button>
            </div>
            <iframe id="preview-iframe" class="flex-grow w-full bg-white rounded border border-cyan-500"></iframe>
        </div>
    </div>

    <!-- MODAL: IMPORT OPTIONS -->
    <div id="import-options-modal" class="hidden fixed inset-0 z-[60] flex items-center justify-center bg-black bg-opacity-70 backdrop-blur-sm transition-opacity">
        <div class="modal-content bg-mid-blue p-6 w-96 rounded-lg border border-cyan-500 shadow-xl shadow-cyan-500/30">
            <h3 class="text-lg font-bold mb-3 neon-cyan">DATA IMPORT MODE</h3>
            <p class="text-sm mb-4">Select how to process the imported **.srcd** file:</p>
            <div class="flex flex-col space-y-3">
                <button id="import-mode-overwrite" class="p-3 text-xs rounded-lg bg-red-700 hover:bg-red-600 glow-border-cyan border-red-500">OVERWRITE: ERASE CURRENT DATA</button>
                <button id="import-mode-merge" class="p-3 text-xs rounded-lg bg-cyan-700 hover:bg-cyan-600 glow-border-cyan border-cyan-500">MERGE: ADD NEW, UPDATE DUPLICATES</button>
                <button id="import-mode-cancel" class="p-2 text-xs rounded-lg bg-slate-700 hover:bg-slate-600">CANCEL</button>
            </div>
        </div>
    </div>

    <!-- FAB: MOBILE MENU -->
    <div id="fab-menu-container" class="fab-menu-container fixed bottom-4 right-4 z-40">
        <div id="fab-actions" class="flex flex-col items-end space-y-2 mb-2 hidden">
            <button id="fab-scratchpad-btn" class="w-10 h-10 rounded-full bg-slate-600 text-white text-lg flex items-center justify-center shadow-lg glow-border-cyan">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="neon-cyan"><path d="M8 2.5V18.5"/><path d="M16 2.5V18.5"/><path d="M22 20.5H2"/><path d="M15 20.5H9"/><path d="M12 20.5v-16"/></svg>
            </button>
            <button id="fab-sdap-btn" class="w-10 h-10 rounded-full bg-slate-600 text-white text-lg flex items-center justify-center shadow-lg glow-border-cyan" title="SDAP-7 Logger">
                <span class="text-yellow-400 font-bold text-xs">ᛸ</span>
            </button>
            <button id="fab-notes-btn" class="w-10 h-10 rounded-full bg-slate-600 text-white text-lg flex items-center justify-center shadow-lg glow-border-cyan">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="neon-cyan"><path d="M15 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7Z"/><path d="M14 2v4a2 2 0 0 0 2 2h4"/><path d="M10 9H8"/><path d="M16 13H8"/><path d="M16 17H8"/></svg>
            </button>
            <button id="fab-list-btn" class="w-10 h-10 rounded-full bg-slate-600 text-white text-lg flex items-center justify-center shadow-lg glow-border-cyan">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="neon-cyan"><line x1="12" x2="19" y1="12" y2="12"/><line x1="12" x2="19" y1="6" y2="6"/><line x1="12" x2="19" y1="18" y2="18"/><path d="M6 12h.01"/><path d="M6 18h.01"/><path d="M6 6h.01"/></svg>
            </button>
        </div>
        <button id="fab-main-btn" class="w-14 h-14 rounded-full bg-cyan-600 text-white text-3xl flex items-center justify-center shadow-xl glow-border-cyan font-['Michroma']">SRC</button>
    </div>
    
    <div id="adr-toast-container"></div>

    <script>
        const generateId = () => Math.random().toString(36).substring(2, 9) + Date.now().toString(36);
        const APP_ID = 'SRC-D2-V1';
        
        const STORAGE_KEYS = {
            PROJECTS: 'srcd2_projects',
            INCIDENTS: 'srcd2_incidents',
            SCRATCHPAD: 'srcd2_scratchpad_v2' 
        };

        /* --- INDEXEDDB SETUP --- */
        const DB_NAME = 'DataBridgeDB2';
        const DB_VERSION = 1;
        const OBJECT_STORE_NAME = 'Attachments';
        let db;

        const openDatabase = () => {
            return new Promise((resolve, reject) => {
                if (!window.indexedDB) return reject(new Error("IndexedDB not supported."));
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = (e) => reject(e.target.error);
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    db.createObjectStore(OBJECT_STORE_NAME, { keyPath: 'id' });
                };
            });
        };

        const saveAttachmentBlob = async (id, blob) => {
            if (!db) await openDatabase();
            return new Promise((resolve, reject) => {
                const tx = db.transaction([OBJECT_STORE_NAME], 'readwrite');
                const req = tx.objectStore(OBJECT_STORE_NAME).put({ id, blob });
                req.onsuccess = () => resolve(true);
                req.onerror = (e) => reject(e.target.error);
            });
        };

        const getAttachmentBlob = async (id) => {
            if (!db) await openDatabase();
            return new Promise((resolve, reject) => {
                const tx = db.transaction([OBJECT_STORE_NAME], 'readonly');
                const req = tx.objectStore(OBJECT_STORE_NAME).get(id);
                req.onsuccess = (e) => resolve(e.target.result ? e.target.result.blob : undefined);
                req.onerror = (e) => reject(e.target.error);
            });
        };

        const deleteAttachmentBlob = async (id) => {
            if (!db) await openDatabase();
            return new Promise((resolve, reject) => {
                const tx = db.transaction([OBJECT_STORE_NAME], 'readwrite');
                const req = tx.objectStore(OBJECT_STORE_NAME).delete(id);
                req.onsuccess = () => resolve(true);
                req.onerror = (e) => reject(e.target.error);
            });
        };

        /* --- APP STATE --- */
        let currentState = {
            projects: [],
            incidents: [],
            selectedItem: null,
            isMobile: window.innerWidth <= 768,
            attachmentContext: null,
            attachmentFileContent: null,
            activeObjectURLs: [],
            activeScratchpadTab: 'main'
        };
        
        const setModalOpen = (isOpen) => document.body.classList.toggle('modal-open', isOpen);
        const $ = (s) => document.querySelector(s);
        const $$ = (s) => document.querySelectorAll(s);

        /* --- DOM ELEMENTS --- */
        const DOMElements = {
            dashboardContainer: $('#dashboard-container'),
            leftPane: $('#left-pane'), rightPane: $('#right-pane'),
            projectList: $('#project-list'), incidentList: $('#incident-list'),
            projectCount: $('#project-count'), incidentCount: $('#incident-count'),
            detailView: $('#detail-view'), detailEmpty: $('#detail-empty'),

            // Modals
            dataModal: $('#data-modal'), dataForm: $('#data-form'), dataModalTitle: $('#data-modal-title'),
            incidentFields: $('#incident-fields'),
            
            // Scratchpad
            scratchpadModal: $('#scratchpad-modal'),
            scratchpadTabs: $$('.scratchpad-tab-btn'),
            scratchpadMain: $('#scratchpad-main'),
            scratchpadCode: $('#scratchpad-code'),
            scratchpadVip: $('#scratchpad-vip'),
            scratchpadTextareas: $$('.scratchpad-textarea'),
            scratchpadPreviewBtn: $('#scratchpad-preview-btn'),
            scratchpadAnalyzeBtn: $('#scratchpad-analyze-btn'),
            
            // Metrics
            spLines: $('#sp-lines'),
            spChars: $('#sp-chars'),

            // ID Analyzer
            analyzerModal: $('#analyzer-modal'),
            analyzerCloseBtn: $('#analyzer-close-btn'),
            analyzerCopyBtn: $('#analyzer-copy-btn'),
            analyzerStatus: $('#analyzer-status'),
            analyzerOutput: $('#analyzer-output'),

            // Others
            previewModal: $('#preview-modal'), previewIframe: $('#preview-iframe'),
            notificationModal: $('#notification-modal'), notificationTitle: $('#notification-title'),
            notificationMessage: $('#notification-message'), notificationCancel: $('#notification-cancel'),
            notificationConfirm: $('#notification-confirm'),
            importOptionsModal: $('#import-options-modal'), importFileInput: $('#import-file-input'),

            attachmentLabelModal: $('#attachment-label-modal'), attachmentLabelForm: $('#attachment-label-form'),
            attachmentLabelInput: $('#attachment-label-input'), attachmentLabelCancel: $('#attachment-label-cancel'),
            attachmentEditModal: $('#attachment-edit-modal'), attachmentEditForm: $('#attachment-edit-form'),
            attachmentEditInput: $('#attachment-edit-label-input'),
            
            // Viewer (Updated)
            rawViewModal: $('#raw-view-modal'), rawViewTitle: $('#raw-view-title'),
            rawViewTextarea: $('#raw-view-textarea'), mediaViewArea: $('#media-view-area'), 
            rawViewCloseBtn: $('#raw-view-close-btn'), viewerCopyBtn: $('#viewer-copy-btn'),

            fabMenuContainer: $('#fab-menu-container'), fabMainBtn: $('#fab-main-btn'),
            fabActions: $('#fab-actions'), fabListBtn: $('#fab-list-btn'),
            fabNotesBtn: $('#fab-notes-btn'), fabScratchpadBtn: $('#fab-scratchpad-btn'),
            fabSdapBtn: $('#fab-sdap-btn'),

            // Control Deck Buttons
            deckNewProject: $('#deck-new-project'), deckNewIncident: $('#deck-new-incident'),
            deckScratchpad: $('#deck-scratchpad'), deckImport: $('#deck-import'), deckExport: $('#deck-export'),
            
            // Ghost Mode
            ghostModeBtn: $('#ghost-mode-btn'),
            netStatusText: $('#net-status-text'),

            scratchpadExportBtn: $('#scratchpad-export-btn'), scratchpadClearBtn: $('#scratchpad-clear-btn'),
            scratchpadCloseBtn: $('#scratchpad-close-btn')
        };

        /* --- TOAST & UTILS --- */
        const showToast = (message, type = 'info', timeout = 2500) => {
            const container = document.getElementById('adr-toast-container');
            const toast = document.createElement('div');
            toast.className = 'adr-toast';
            toast.innerHTML = message;
            
            if (type === 'success') toast.style.borderLeftColor = 'var(--secondary)';
            else if (type === 'error') toast.style.borderLeftColor = 'var(--critical)';
            else toast.style.borderLeftColor = 'var(--primary)';

            container.appendChild(toast);
            void toast.offsetWidth; 
            toast.style.opacity = 1;
            setTimeout(() => {
                toast.style.opacity = 0;
                setTimeout(() => toast.remove(), 500);
            }, timeout);
        };

        const generateLocalTimestampFilename = () => {
            const now = new Date();
            const pad = (num) => num.toString().padStart(2, '0');
            const year = now.getFullYear();
            const month = pad(now.getMonth() + 1);
            const day = pad(now.getDate());
            const hours = pad(now.getHours());
            const minutes = pad(now.getMinutes());
            const seconds = pad(now.getSeconds());
            return `${year}-${month}-${day}_${hours}-${minutes}-${seconds}`;
        };

        const getFromLocalStorage = (key) => {
            try { return JSON.parse(localStorage.getItem(key)) || []; } catch { return []; }
        };
        
        const saveToLocalStorage = (key, data) => {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true; 
            } catch (e) {
                if (e.name === 'QuotaExceededError' || e.name === 'NS_ERROR_DOM_QUOTA_REACHED') {
                    console.error("CRITICAL: LocalStorage Quota Exceeded.", e);
                    if (typeof showToast === 'function') {
                        showToast('⚠️ STORAGE FULL: DATA NOT SAVED. Export & Clear Data.', 'error', 5000);
                    } else {
                        alert('CRITICAL: STORAGE FULL. Export required.');
                    }
                } else {
                    console.error("LocalStorage Error:", e);
                }
                return false; 
            }
        };

        const getScratchpadFromSessionStorage = () => {
            try {
                const data = sessionStorage.getItem(STORAGE_KEYS.SCRATCHPAD);
                if (!data) return { main: '', code: '', vip: '' };
                const parsed = JSON.parse(data);
                if (parsed.snippet && !parsed.code) parsed.code = parsed.snippet;
                return { main: '', code: '', vip: '', ...parsed };
            } catch { return { main: '', code: '', vip: '' }; }
        };
        const saveScratchpadToSessionStorage = (data) => sessionStorage.setItem(STORAGE_KEYS.SCRATCHPAD, JSON.stringify(data));

        const revokeActiveURLs = () => {
            currentState.activeObjectURLs.forEach(url => URL.revokeObjectURL(url));
            currentState.activeObjectURLs = [];
        };

        const confirmAction = (message, title, callback) => {
            setModalOpen(true);
            DOMElements.notificationTitle.textContent = title;
            DOMElements.notificationMessage.innerHTML = message;
            
            const isCritical = title.includes('ERROR') || title.includes('DELETION') || title.includes('DELETE') || title.includes('CLEAR');
            const modalContent = DOMElements.notificationModal.querySelector('.modal-content');
            
            if (isCritical) {
                modalContent.classList.replace('border-cyan-500', 'border-red-500');
                modalContent.classList.add('shadow-red-500/30');
                DOMElements.notificationTitle.className = 'text-lg font-bold mb-3 text-red-400';
            } else {
                modalContent.classList.replace('border-red-500', 'border-cyan-500');
                modalContent.classList.remove('shadow-red-500/30');
                DOMElements.notificationTitle.className = 'text-lg font-bold mb-3 text-cyan-400';
            }

            if (callback) {
                DOMElements.notificationCancel.classList.remove('hidden');
                DOMElements.notificationConfirm.textContent = 'CONFIRM';
                DOMElements.notificationConfirm.onclick = () => {
                    DOMElements.notificationModal.classList.add('hidden');
                    if(DOMElements.scratchpadModal.classList.contains('hidden')) setModalOpen(false);
                    callback();
                };
                DOMElements.notificationCancel.onclick = () => {
                    DOMElements.notificationModal.classList.add('hidden');
                    if(DOMElements.scratchpadModal.classList.contains('hidden')) setModalOpen(false);
                };
            } else {
                DOMElements.notificationCancel.classList.add('hidden');
                DOMElements.notificationConfirm.textContent = 'OK';
                DOMElements.notificationConfirm.onclick = () => {
                    DOMElements.notificationModal.classList.add('hidden');
                    if(DOMElements.scratchpadModal.classList.contains('hidden')) setModalOpen(false);
                };
            }
            DOMElements.notificationModal.classList.remove('hidden');
        };

        /* --- SORTING UTILITIES --- */
        const extractSortableNumber = (label) => {
            if (!label) return null;
            const matches = label.match(/\d+/g);
            if (matches && matches.length > 0) {
                return matches.reduce((max, numStr) => Math.max(max, parseInt(numStr, 10)), 0);
            }
            return null;
        };

        const extractDateFromLabel = (label) => {
            if (!label) return null;
            let match = label.match(/(\d{4}[-./]\d{1,2}[-./]\d{1,2})/);
            if (match) return match[0].replace(/[-./]/g, '-');
            match = label.match(/(\d{1,2}\/\d{1,2}\/\d{2,4})/);
            if (match) {
                const d = new Date(match[0]);
                if (!isNaN(d)) return d.toISOString().split('T')[0];
            }
            return null;
        };

        const getPrimarySortValue = (item) => {
            let highestNumber = null;
            let latestDate = item.createdAt || '1970-01-01'; 
            
            (item.attachments || []).forEach(att => {
                const num = extractSortableNumber(att.label);
                if (num !== null) {
                    if (highestNumber === null || num > highestNumber) highestNumber = num;
                }
                const date = extractDateFromLabel(att.label);
                if (date && date > latestDate) latestDate = date;
            });

            if (highestNumber !== null) {
                return { type: 'number', value: String(highestNumber).padStart(10, '0') };
            }
            return { type: 'date', value: latestDate };
        };

        /* --- UPSERT MERGE LOGIC --- */
        const mergeData = (existingArray, newDataArray) => {
            const existingMap = new Map(existingArray.map(item => [item.id, item]));
            let addedCount = 0;
            let updatedCount = 0;

            (newDataArray || []).forEach(newItem => {
                if (existingMap.has(newItem.id)) {
                    Object.assign(existingMap.get(newItem.id), newItem);
                    updatedCount++;
                } else {
                    existingMap.set(newItem.id, newItem);
                    addedCount++;
                }
            });
            
            return { 
                mergedArray: Array.from(existingMap.values()), 
                addedCount, 
                updatedCount 
            };
        };

        const finalizeImport = (mode) => {
            const data = window.importedData;
            DOMElements.importOptionsModal.classList.add('hidden');
            setModalOpen(false);
            
            let currentProjects = getFromLocalStorage(STORAGE_KEYS.PROJECTS);
            let currentIncidents = getFromLocalStorage(STORAGE_KEYS.INCIDENTS);
            let currentScratchpad = getScratchpadFromSessionStorage();

            let finalProjects, finalIncidents, finalScratchpad;
            let msg = '';

            if (mode === 'overwrite') {
                finalProjects = data.projects || [];
                finalIncidents = data.incidents || [];
                finalScratchpad = data.scratchpad || { main: '', code: '', vip: '' };
                msg = `Import Success (OVERWRITE): ${finalProjects.length} Projects, ${finalIncidents.length} Incidents.`;
            } else {
                const pResult = mergeData(currentProjects, data.projects);
                const iResult = mergeData(currentIncidents, data.incidents);
                finalProjects = pResult.mergedArray;
                finalIncidents = iResult.mergedArray;
                
                finalScratchpad = { ...currentScratchpad };
                if (data.scratchpad) {
                    if (data.scratchpad.main !== undefined) finalScratchpad.main = data.scratchpad.main;
                    if (data.scratchpad.code !== undefined) finalScratchpad.code = data.scratchpad.code;
                    else if (data.scratchpad.snippet !== undefined) finalScratchpad.code = data.scratchpad.snippet;
                    if (data.scratchpad.vip !== undefined) finalScratchpad.vip = data.scratchpad.vip;
                }
                
                msg = `Import Success (MERGE): ${pResult.addedCount + iResult.addedCount} Added, ${pResult.updatedCount + iResult.updatedCount} Updated.`;
            }

            saveToLocalStorage(STORAGE_KEYS.PROJECTS, finalProjects);
            saveToLocalStorage(STORAGE_KEYS.INCIDENTS, finalIncidents);
            saveScratchpadToSessionStorage(finalScratchpad);
            
            currentState.projects = finalProjects;
            currentState.incidents = finalIncidents;
            
            renderList(DOMElements.projectList, currentState.projects, 'project');
            renderList(DOMElements.incidentList, currentState.incidents, 'incident');
            DOMElements.detailView.innerHTML = DOMElements.detailEmpty.outerHTML;
            currentState.selectedItem = null;
            
            showToast(msg, 'success');
        };

        /* --- EXPORT FUNCTIONS --- */
        const handleFullExport = () => {
            const spData = getScratchpadFromSessionStorage();
            const data = {
                projects: currentState.projects,
                incidents: currentState.incidents,
                scratchpad: spData,
                appId: 'SRC-D2-V1',
                exportTimestamp: new Date().toISOString(),
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const filename = `SRCD2_${generateLocalTimestampFilename()}.srcd`;
            a.download = filename;
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast(`Backup Saved: ${filename}`, 'success');
        };

        const handleScratchpadExport = () => {
            const activeTabKey = currentState.activeScratchpadTab;
            const content = $(`#scratchpad-${activeTabKey}`).value;
            if (!content.trim()) return showToast(`Cannot export: ${activeTabKey.toUpperCase()} is empty.`, 'info');
            
            let prefix = 'MAIN';
            if (activeTabKey === 'code') prefix = 'CODE';
            else if (activeTabKey === 'vip') prefix = 'VIP';
            
            const data = {
                scratchpad: { [activeTabKey]: content },
                appId: `SRC-D2-${prefix}-EXPORT`,
                exportTimestamp: new Date().toISOString(),
            };
            const json = JSON.stringify(data, null, 2);
            const blob = new Blob([json], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            const filename = `${prefix}_${generateLocalTimestampFilename()}.srcd`;
            a.download = filename;
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            showToast(`Saved ${filename}`, 'success');
        };

        const handleScratchpadClear = () => {
            const activeTabKey = currentState.activeScratchpadTab;
            const textarea = $(`#scratchpad-${activeTabKey}`);
            if (!textarea.value.trim()) return showToast('Buffer empty.', 'info');
            confirmAction(`Clear **${activeTabKey.toUpperCase()}** buffer?`, 'CONFIRM CLEAR', () => {
                textarea.value = '';
                const currentPads = getScratchpadFromSessionStorage();
                currentPads[activeTabKey] = '';
                saveScratchpadToSessionStorage(currentPads); 
                updateScratchpadMetrics();
                showToast(`${activeTabKey.toUpperCase()} cleared.`, 'error');
            });
        };

        /* --- METRICS & ANALYZER --- */
        const updateScratchpadMetrics = () => {
            const activeTextarea = Array.from(DOMElements.scratchpadTextareas).find(t => !t.classList.contains('hidden'));
            if (activeTextarea) {
                const text = activeTextarea.value;
                const lines = text.length > 0 ? text.split(/\r\n|\r|\n/).length : 0;
                DOMElements.spLines.textContent = lines;
                DOMElements.spChars.textContent = text.length;
            }
        };

        const runIdAnalysis = () => {
            const mainContent = DOMElements.scratchpadMain.value;
            const codeContent = DOMElements.scratchpadCode.value; 
            if (!mainContent.trim() || !codeContent.trim()) return showToast('Analysis requires HTML in both MAIN and CODE tabs.', 'error');

            const parser = new DOMParser();
            const docMain = parser.parseFromString(mainContent, 'text/html');
            const docCode = parser.parseFromString(codeContent, 'text/html');

            const getIds = (doc) => Array.from(doc.querySelectorAll('[id]')).map(el => el.getAttribute('id')).filter(id => id);
            
            const mainIds = getIds(docMain);
            const codeIds = getIds(docCode);
            const missingIds = mainIds.filter(id => !codeIds.includes(id));

            setModalOpen(true);
            DOMElements.analyzerModal.classList.remove('hidden');

            if (missingIds.length === 0) {
                DOMElements.analyzerStatus.innerHTML = `<span class="text-green-400 glow-text-secondary">SYSTEM SYNC: 100% ID INTEGRITY</span>`;
                DOMElements.analyzerOutput.value = "ANALYSIS COMPLETE > SUCCESS\n\nNo ID regressions detected.\nThe Code version preserves all logic hooks found in the Source of Truth.";
                DOMElements.analyzerOutput.className = "flex-grow w-full p-4 bg-black/40 border border-green-500 rounded text-green-400 font-['Space_Mono'] text-xs resize-none focus:outline-none focus:border-green-400";
            } else {
                DOMElements.analyzerStatus.innerHTML = `<span class="neon-cyan glow-text-cyan">WARNING: ID REGRESSION DETECTED (${missingIds.length})</span>`;
                DOMElements.analyzerOutput.value = `ANALYSIS REPORT > MISSING IDENTIFIERS\n\nCONTEXT:\nThe provided Code is missing the following ID hooks present in Main.\nFunctionality attached to these IDs will break.\n\nMISSING IDs LIST:\n${missingIds.map(id => `- #${id}`).join('\n')}\n\nINSTRUCTION FOR AI:\nPlease regenerate the code. You must preserve the IDs listed above in their respective elements to maintain application logic.`;
                DOMElements.analyzerOutput.className = "flex-grow w-full p-4 bg-black/40 border border-red-500 rounded text-red-300 font-['Space_Mono'] text-xs resize-none focus:outline-none focus:border-red-500";
            }
        };

        /* --- CORE FUNCTIONS --- */
        const renderList = (listEl, data, type) => {
            listEl.innerHTML = '';
            
            data.sort((a, b) => {
                if (type === 'incident') {
                    const sortA = getPrimarySortValue(a);
                    const sortB = getPrimarySortValue(b);
                    if (sortA.type === 'number' && sortB.type === 'number') return sortB.value.localeCompare(sortA.value);
                    if (sortA.type === 'number' && sortB.type === 'date') return -1;
                    if (sortA.type === 'date' && sortB.type === 'number') return 1;
                    return sortB.value.localeCompare(sortA.value);
                } else {
                    const dateA = a.dueDate || '9999-12-31';
                    const dateB = b.dueDate || '9999-12-31';
                    return dateA.localeCompare(dateB);
                }
            });
            
            data.forEach(item => {
                const div = document.createElement('div');
                div.className = `p-3 bg-mid-blue rounded-lg cursor-pointer hover:bg-slate-700 transition border-l-4 ${type==='project'?'border-cyan-500':'border-green-500'} flex justify-between items-center text-sm`;
                
                div.addEventListener('click', (e) => {
                    if (!e.target.closest('button')) {
                        renderDetail(item.id, type);
                    }
                });

                let badgeColor = 'bg-cyan-900';
                if (type === 'incident') {
                    if (item.status === 'Active') badgeColor = 'bg-red-800';
                    else if (item.status === 'Resolved') badgeColor = 'bg-green-800';
                }
                
                div.innerHTML = `
                    <div class="truncate pr-4 pointer-events-none min-w-0 flex-grow">
                        <span class="font-bold mr-2 text-white">${item.title}</span>
                        ${item.status ? `<span class="px-2 py-0.5 text-xs rounded-full ${badgeColor} text-white">${item.status.toUpperCase()}</span>` : ''}
                    </div>
                    <div class="flex space-x-2 text-xs items-center flex-shrink-0">
                        <button class="glyph-btn text-yellow-400 hover:text-yellow-200 edit-btn" data-id="${item.id}" data-type="${type}" title="Edit">[ ⋊ ]</button>
                        <button class="glyph-btn text-red-400 hover:text-red-200 delete-btn" data-id="${item.id}" data-type="${type}" title="Delete">[ ⟁ ]</button>
                    </div>`;
                listEl.appendChild(div);
            });
            
            listEl.querySelectorAll('.edit-btn').forEach(btn => 
                btn.addEventListener('click', (e) => openDataModal(e.target.dataset.type, e.target.dataset.id))
            );
            listEl.querySelectorAll('.delete-btn').forEach(btn => 
                btn.addEventListener('click', (e) => deleteItem(e.target.dataset.id, e.target.dataset.type))
            );

            if(type==='project') DOMElements.projectCount.textContent = data.length;
            else DOMElements.incidentCount.textContent = data.length;
        };

        const renderDetail = (id, type) => {
            const list = type === 'project' ? currentState.projects : currentState.incidents;
            const item = list.find(i => i.id === id);
            if (!item) return;

            currentState.selectedItem = { id, type };
            const fields = [];
            fields.push({ label: 'TYPE', value: type.toUpperCase() });
            if (item.number) fields.push({ label: 'INCIDENT NUMBER', value: item.number });
            if (item.owner) fields.push({ label: 'OWNER/CONTACT', value: item.owner });
            fields.push({ label: 'STATUS', value: item.status || 'N/A', color: item.status === 'Active' ? 'text-red-400' : (item.status === 'Resolved' ? 'text-green-400' : 'text-cyan-400') });
            if (item.dueDate) fields.push({ label: 'TARGET DATE', value: item.dueDate });

            const attachmentsHtml = (item.attachments || []).map((att, idx) => `
                <div class="flex justify-between items-center border-b border-gray-700 py-3 text-sm">
                    <span class="text-yellow-400 truncate w-1/3 text-left pl-1 min-w-0" title="${att.label}">${att.label}</span>
                    <span class="text-gray-500 text-xs truncate flex-grow mx-2 min-w-0" title="${att.filename}">${att.filename}</span>
                    <div class="flex items-center flex-shrink-0">
                        <button class="glyph-btn view-att text-cyan-400 hover:text-cyan-200 mx-0.5" data-idx="${idx}" title="View Content">[ ⊛ ]</button>
                        <button class="glyph-btn edit-att text-yellow-400 hover:text-yellow-200 mx-0.5" data-idx="${idx}" title="Edit Label">[ ⋊ ]</button>
                        <button class="glyph-btn del-att text-red-400 hover:text-red-200 mx-0.5" data-idx="${idx}" title="Delete">[ ⟁ ]</button>
                    </div>
                </div>`).join('');

            DOMElements.detailView.innerHTML = `
                <div class="h-full flex flex-col">
                    <!-- TOP HALF: Details + Notes -->
                    <div class="h-1/2 flex flex-col pr-2 border-b border-cyan-900/30 pb-2">
                        <div class="flex justify-between items-start mb-2 flex-shrink-0">
                            <h2 class="text-3xl font-['Michroma'] ${type==='project'?'neon-cyan':'neon-green'} pr-4 truncate min-w-0">${item.title}</h2>
                            <div class="flex space-x-2 mt-1 shrink-0"> 
                                <button id="detail-edit" class="p-2 text-xs rounded-lg bg-yellow-700 hover:bg-yellow-600 glow-btn-yellow text-white" title="Edit Entry">[ ⋊ ]</button>
                                <button id="detail-delete" class="p-2 text-xs rounded-lg bg-red-800 hover:bg-red-700 glow-btn-red text-white" title="Delete Entry">[ ⟁ ]</button>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-4 mb-2 flex-shrink-0">
                            ${fields.map(f => `<div class="p-3 bg-mid-blue rounded border-l-2 border-cyan-500"><p class="text-xs text-gray-400">${f.label}</p><p class="text-sm font-bold ${f.color||'text-white'} truncate">${f.value}</p></div>`).join('')}
                        </div>
                        
                        <div class="flex-grow overflow-hidden p-3 bg-mid-blue rounded-lg glow-border-cyan flex flex-col panel-grid-bg">
                            <h3 class="text-lg neon-cyan mb-2 border-b border-cyan-500 pb-1 flex-shrink-0">NOTES/SUMMARY</h3>
                            <div class="flex-grow overflow-y-auto pr-2">
                                <p class="whitespace-pre-wrap text-sm">${item.notes || 'No notes.'}</p>
                            </div>
                        </div>
                    </div>

                    <!-- BOTTOM HALF: Attachments -->
                    <div class="h-1/2 flex flex-col pt-2">
                        <div class="flex-grow overflow-hidden p-3 bg-mid-blue rounded-lg glow-border-cyan flex flex-col panel-grid-bg">
                            <div class="flex justify-between items-center mb-2 border-b border-green-500 pb-1 flex-shrink-0">
                                <h3 class="text-lg neon-green">ATTACHMENTS (${item.attachments ? item.attachments.length : 0})</h3>
                                <button id="detail-attach" class="p-2 text-xs rounded-lg bg-green-700 hover:bg-green-600 glow-btn-green text-white">[ + ATTACH ]</button>
                            </div>
                            <div class="flex-grow overflow-y-auto pr-2 space-y-1 pb-24">
                                ${attachmentsHtml || '<p class="text-xs text-gray-500">No attachments found.</p>'}
                            </div>
                        </div>
                    </div>
                </div>`;
            
            $('#detail-edit').onclick = () => openDataModal(type, id);
            $('#detail-delete').onclick = () => deleteItem(id, type);
            $('#detail-attach').onclick = () => { currentState.attachmentContext = { id, type }; DOMElements.importFileInput.click(); };
            
            $$('.view-att').forEach(b => b.onclick = (e) => handleViewAttachment(id, type, e.target.dataset.idx));
            $$('.edit-att').forEach(b => b.onclick = (e) => openAttachmentEditModal(id, type, e.target.dataset.idx));
            $$('.del-att').forEach(b => b.onclick = (e) => handleDeleteAttachment(id, type, e.target.dataset.idx));
            
            if(currentState.isMobile) setMobileView('detail');
        };

        const deleteItem = (id, type) => {
            confirmAction(`Confirm deletion of ${type.toUpperCase()} ID: ${id}?`, 'CONFIRM DELETION', () => {
                const key = type === 'project' ? STORAGE_KEYS.PROJECTS : STORAGE_KEYS.INCIDENTS;
                let list = getFromLocalStorage(key).filter(i => i.id !== id);
                saveToLocalStorage(key, list);
                if (type === 'project') currentState.projects = list; else currentState.incidents = list;
                renderList(type==='project'?DOMElements.projectList:DOMElements.incidentList, list, type);
                if (currentState.selectedItem?.id === id) {
                    DOMElements.detailView.innerHTML = DOMElements.detailEmpty.outerHTML;
                    currentState.selectedItem = null;
                }
                showToast('Entry deleted.', 'error');
            });
        };

        const openDataModal = (type, id = null) => {
            setModalOpen(true);
            DOMElements.dataForm.reset();
            DOMElements.dataForm['data-id'].value = id || generateId();
            DOMElements.dataForm['data-type'].value = type;
            DOMElements.dataModalTitle.textContent = (id ? 'EDIT' : 'NEW') + ' ENTRY > ' + type.toUpperCase();
            DOMElements.incidentFields.classList.toggle('hidden', type === 'project');
            if (id) {
                const item = (type==='project'?currentState.projects:currentState.incidents).find(i => i.id === id);
                if (item) {
                    DOMElements.dataForm['data-title'].value = item.title;
                    DOMElements.dataForm['data-status'].value = item.status;
                    DOMElements.dataForm['data-due-date'].value = item.dueDate;
                    DOMElements.dataForm['data-notes'].value = item.notes;
                    if(type!=='project') {
                        DOMElements.dataForm['data-owner'].value = item.owner;
                        DOMElements.dataForm['data-number'].value = item.number;
                    }
                }
            }
            DOMElements.dataModal.classList.remove('hidden');
        };

        const handleDataSubmit = (e) => {
            e.preventDefault();
            const f = DOMElements.dataForm;
            const id = f['data-id'].value, type = f['data-type'].value;
            const key = type === 'project' ? STORAGE_KEYS.PROJECTS : STORAGE_KEYS.INCIDENTS;
            let list = getFromLocalStorage(key);
            const exists = list.find(i => i.id === id);
            const payload = {
                id, title: f['data-title'].value, status: f['data-status'].value,
                dueDate: f['data-due-date'].value, notes: f['data-notes'].value,
                attachments: exists ? exists.attachments : [],
                createdAt: exists ? exists.createdAt : new Date().toISOString()
            };
            if(type!=='project') { payload.owner = f['data-owner'].value; payload.number = f['data-number'].value; }
            if(exists) list = list.map(i => i.id===id ? {...i, ...payload} : i); else list.push(payload);
            
            if (!saveToLocalStorage(key, list)) return;

            if(type==='project') currentState.projects = list; else currentState.incidents = list;
            renderList(type==='project'?DOMElements.projectList:DOMElements.incidentList, list, type);
            if(currentState.selectedItem?.id === id) renderDetail(id, type);
            DOMElements.dataModal.classList.add('hidden');
            setModalOpen(false);
            showToast('Protocol saved.', 'success');
        };

        /* --- ATTACHMENTS --- */
        const handleFileSelected = (e) => {
            const file = e.target.files[0];
            if(!file) return;
            const { id, type } = currentState.attachmentContext;
            if(type === 'global_import') {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try { window.importedData = JSON.parse(ev.target.result); 
                        DOMElements.importOptionsModal.classList.remove('hidden'); setModalOpen(true);
                    } catch { showToast('Invalid .srcd file.', 'error'); }
                };
                reader.readAsText(file); e.target.value = ''; return;
            }
            const uid = `attach-${Date.now()}-${Math.random().toString(36).substring(2)}`;
            if(file.name.endsWith('.srcd')) {
                const reader = new FileReader();
                reader.onload = (ev) => {
                    try {
                        const json = JSON.parse(ev.target.result);
                        currentState.attachmentFileContent = JSON.stringify(json);
                        currentState.attachmentContext.fileName = file.name;
                        currentState.attachmentContext.mimeType = 'application/json-srcd';
                        DOMElements.attachmentLabelInput.value = file.name;
                        DOMElements.attachmentLabelModal.classList.remove('hidden'); setModalOpen(true);
                    } catch { showToast('Error reading .srcd attachment.', 'error'); }
                };
                reader.readAsText(file);
            } else {
                saveAttachmentBlob(uid, file).then(() => {
                    currentState.attachmentFileContent = uid;
                    currentState.attachmentContext.fileName = file.name;
                    currentState.attachmentContext.mimeType = file.type;
                    DOMElements.attachmentLabelInput.value = file.name;
                    DOMElements.attachmentLabelModal.classList.remove('hidden'); setModalOpen(true);
                }).catch(err => showToast('DB Error: '+err, 'error'));
            }
            e.target.value = '';
        };

        const handleAttachmentLabelSubmit = (e) => {
            e.preventDefault();
            const { id, type, fileName, mimeType } = currentState.attachmentContext;
            const label = DOMElements.attachmentLabelInput.value;
            const key = type === 'project' ? STORAGE_KEYS.PROJECTS : STORAGE_KEYS.INCIDENTS;
            let list = getFromLocalStorage(key);
            list = list.map(i => {
                if(i.id === id) {
                    i.attachments = i.attachments || [];
                    i.attachments.push({
                        id: currentState.attachmentFileContent.startsWith('attach-') ? currentState.attachmentFileContent : undefined,
                        content: currentState.attachmentFileContent.startsWith('attach-') ? undefined : currentState.attachmentFileContent,
                        filename: fileName, label, mimeType, timestamp: new Date().toISOString()
                    });
                }
                return i;
            });

            if (!saveToLocalStorage(key, list)) return;

            if(type==='project') currentState.projects = list; else currentState.incidents = list;
            DOMElements.attachmentLabelModal.classList.add('hidden');
            setModalOpen(false);
            renderDetail(id, type);
            showToast('File attached.', 'success');
        };

        const handleViewAttachment = async (id, type, idx) => {
            const item = (type==='project'?currentState.projects:currentState.incidents).find(i=>i.id===id);
            const att = item.attachments[idx];
            revokeActiveURLs();
            setModalOpen(true);
            
            let displayContent = '';

            if(att.content) {
                if (att.filename.endsWith('.srcd') || att.mimeType === 'application/json-srcd') {
                    try {
                        const parsed = JSON.parse(att.content);
                        const parts = [];

                        const extractParts = (obj) => {
                            if (obj.main) parts.push({ label: 'MAIN', content: obj.main });
                            if (obj.code) parts.push({ label: 'CODE', content: obj.code });
                            if (obj.snippet) parts.push({ label: 'CODE', content: obj.snippet });
                            if (obj.vip) parts.push({ label: 'VIP CONTEXT', content: obj.vip });
                        };

                        if (parsed.scratchpad) extractParts(parsed.scratchpad);
                        else extractParts(parsed);

                        if (parts.length === 1) {
                            displayContent = parts[0].content;
                        } else if (parts.length > 1) {
                            displayContent = parts.map(p => `<!-- ${p.label} -->\n${p.content}`).join('\n\n' + '-'.repeat(40) + '\n\n');
                        } else {
                            displayContent = JSON.stringify(parsed, null, 2);
                        }

                    } catch (e) {
                        displayContent = att.content; 
                    }
                } else {
                    displayContent = att.content;
                }
                
                DOMElements.rawViewTitle.textContent = `VIEW > ${att.filename}`;
                DOMElements.rawViewTextarea.value = displayContent;
                DOMElements.rawViewTextarea.classList.remove('hidden');
                DOMElements.mediaViewArea.classList.add('hidden');
                DOMElements.rawViewModal.classList.remove('hidden');

            } else if (att.id) {
                const blob = await getAttachmentBlob(att.id);
                if(blob) {
                    const url = URL.createObjectURL(blob);
                    currentState.activeObjectURLs.push(url);
                    DOMElements.rawViewTitle.textContent = `VIEW > ${att.filename}`;
                    DOMElements.rawViewTextarea.classList.add('hidden');
                    DOMElements.mediaViewArea.classList.remove('hidden');
                    if(att.mimeType.startsWith('image/')) DOMElements.mediaViewArea.innerHTML = `<img src="${url}" class="max-w-full max-h-full object-contain">`;
                    else if(att.mimeType === 'application/pdf') DOMElements.mediaViewArea.innerHTML = `<iframe src="${url}" class="w-full h-full border-none"></iframe>`;
                    else DOMElements.mediaViewArea.innerHTML = `<a href="${url}" download="${att.filename}" class="neon-cyan">Download Binary File</a>`;
                    DOMElements.rawViewModal.classList.remove('hidden');
                } else showToast('Data missing in DB.', 'error');
            }
        };
        
        const handleDeleteAttachment = (id, type, idx) => {
            const item = (type==='project'?currentState.projects:currentState.incidents).find(i=>i.id===id);
            const att = item.attachments[idx];
            confirmAction(`Delete attachment: ${att.filename}?`, 'DELETE FILE', async () => {
                if(att.id) await deleteAttachmentBlob(att.id);
                item.attachments.splice(idx, 1);
                const key = type === 'project' ? STORAGE_KEYS.PROJECTS : STORAGE_KEYS.INCIDENTS;
                let list = getFromLocalStorage(key).map(i => i.id===id ? item : i);
                saveToLocalStorage(key, list);
                if(type==='project') currentState.projects = list; else currentState.incidents = list;
                renderDetail(id, type);
                showToast('Attachment deleted.', 'error');
            });
        };

        const openAttachmentEditModal = (id, type, idx) => {
            const item = (type==='project'?currentState.projects:currentState.incidents).find(i=>i.id===id);
            DOMElements.attachmentEditForm['edit-item-id'].value = id;
            DOMElements.attachmentEditForm['edit-item-type'].value = type;
            DOMElements.attachmentEditForm['edit-att-index'].value = idx;
            DOMElements.attachmentEditInput.value = item.attachments[idx].label;
            setModalOpen(true);
            DOMElements.attachmentEditModal.classList.remove('hidden');
        };

        /* --- SCRATCHPAD LOGIC --- */
        const openScratchpad = () => {
            const data = getScratchpadFromSessionStorage();
            DOMElements.scratchpadMain.value = data.main;
            DOMElements.scratchpadCode.value = data.code;
            DOMElements.scratchpadVip.value = data.vip;
            setModalOpen(true);
            DOMElements.scratchpadModal.classList.remove('hidden');
            updateScratchpadMetrics();
        };

        const switchTab = (tab) => {
            currentState.activeScratchpadTab = tab;
            DOMElements.scratchpadTabs.forEach(b => {
                const active = b.dataset.tab === tab;
                b.classList.toggle('active-tab', active);
                b.classList.toggle('neon-cyan', active);
                b.classList.toggle('text-white', !active);
                b.classList.toggle('opacity-70', !active);
            });
            DOMElements.scratchpadTextareas.forEach(t => t.classList.toggle('hidden', t.dataset.tab !== tab));
            updateScratchpadMetrics();
        };

        const handleScratchpadPreview = () => {
            const content = DOMElements.scratchpadTextareas[0].parentNode.querySelector(`textarea:not(.hidden)`).value;
            const doc = DOMElements.previewIframe.contentWindow.document;
            doc.open();
            doc.write(content.includes('<html') ? content : `<html><body style="background:#050A19;color:#0ff;font-family:monospace">${content}</body></html>`);
            doc.close();
            setModalOpen(true);
            DOMElements.previewModal.classList.remove('hidden');
        };

        /* --- MOBILE --- */
        const setMobileView = (view) => {
            if(!currentState.isMobile) return;
            DOMElements.dashboardContainer.classList.remove('mobile-list-view', 'mobile-detail-view');
            DOMElements.dashboardContainer.classList.add(view === 'list' ? 'mobile-list-view' : 'mobile-detail-view');
            DOMElements.fabMainBtn.textContent = view === 'list' ? 'SRC' : 'BACK';
            DOMElements.fabActions.classList.add('hidden');
        };

        /* --- GHOST MODE LOGIC --- */
        const toggleGhostMode = () => {
            document.body.classList.toggle('ghost-mode');
            const isGhost = document.body.classList.contains('ghost-mode');
            DOMElements.ghostModeBtn.style.color = isGhost ? '#fff' : '';
            showToast(isGhost ? 'SHADOW WOLF: ACTIVE' : 'SHADOW WOLF: DISENGAGED', isGhost ? 'error' : 'info');
        };

        const updateNetworkStatus = () => {
            const isOnline = navigator.onLine;
            DOMElements.netStatusText.textContent = isOnline ? '[ LINK: ONLINE ]' : '[ LINK: OFFLINE ]';
            DOMElements.netStatusText.className = isOnline ? 'neon-cyan' : 'text-gray-500';
        };

        /* --- INIT --- */
        const initApp = async () => {
            await openDatabase();
            currentState.projects = getFromLocalStorage(STORAGE_KEYS.PROJECTS);
            currentState.incidents = getFromLocalStorage(STORAGE_KEYS.INCIDENTS);
            renderList(DOMElements.projectList, currentState.projects, 'project');
            renderList(DOMElements.incidentList, currentState.incidents, 'incident');

            // Listeners: Modals
            $('#data-cancel-btn').onclick = () => { DOMElements.dataModal.classList.add('hidden'); setModalOpen(false); };
            DOMElements.dataForm.onsubmit = handleDataSubmit;

            // Listeners: Control Deck Buttons
            DOMElements.deckNewProject.onclick = () => openDataModal('project');
            DOMElements.deckNewIncident.onclick = () => openDataModal('incident');
            DOMElements.deckScratchpad.onclick = openScratchpad;
            DOMElements.deckImport.onclick = () => { currentState.attachmentContext = {type:'global_import'}; DOMElements.importFileInput.click(); };
            DOMElements.deckExport.onclick = handleFullExport;
            
            DOMElements.importFileInput.onchange = handleFileSelected;
            
            // Listeners: Ghost Mode
            DOMElements.ghostModeBtn.onclick = toggleGhostMode;
            window.addEventListener('online', updateNetworkStatus);
            window.addEventListener('offline', updateNetworkStatus);
            updateNetworkStatus();

            // Listeners: Scratchpad
            DOMElements.scratchpadCloseBtn.onclick = () => { DOMElements.scratchpadModal.classList.add('hidden'); setModalOpen(false); };
            DOMElements.scratchpadTabs.forEach(b => b.onclick = (e) => switchTab(e.target.dataset.tab));
            DOMElements.scratchpadTextareas.forEach(t => t.oninput = (e) => {
                const d = getScratchpadFromSessionStorage();
                d[e.target.dataset.tab] = e.target.value;
                saveScratchpadToSessionStorage(d);
                updateScratchpadMetrics();
            });
            DOMElements.scratchpadPreviewBtn.onclick = handleScratchpadPreview;
            DOMElements.scratchpadAnalyzeBtn.onclick = runIdAnalysis;
            DOMElements.scratchpadExportBtn.onclick = handleScratchpadExport; 
            DOMElements.scratchpadClearBtn.onclick = handleScratchpadClear;

            // Listeners: Analyzer Modal
            DOMElements.analyzerCloseBtn.onclick = () => { 
                DOMElements.analyzerModal.classList.add('hidden'); 
            };
            DOMElements.analyzerCopyBtn.onclick = () => {
                DOMElements.analyzerOutput.select();
                navigator.clipboard.writeText(DOMElements.analyzerOutput.value)
                    .then(() => showToast('Report copied to clipboard.', 'success'))
                    .catch(() => showToast('Clipboard access failed.', 'error'));
            };

            // Listeners: Misc
            if(DOMElements.previewModal) {
                $('#preview-close-btn').onclick = () => { DOMElements.previewModal.classList.add('hidden'); setModalOpen(false); };
            }

            if(DOMElements.rawViewCloseBtn) {
                DOMElements.rawViewCloseBtn.addEventListener('click', () => {
                    DOMElements.rawViewModal.classList.add('hidden');
                    setModalOpen(false);
                });
            }

            DOMElements.viewerCopyBtn.onclick = () => {
                DOMElements.rawViewTextarea.select();
                navigator.clipboard.writeText(DOMElements.rawViewTextarea.value)
                    .then(() => showToast('Content copied.', 'success'))
                    .catch(() => showToast('Clipboard failed.', 'error'));
            }
            DOMElements.attachmentLabelCancel.onclick = () => { DOMElements.attachmentLabelModal.classList.add('hidden'); setModalOpen(false); };
            DOMElements.attachmentLabelForm.onsubmit = handleAttachmentLabelSubmit;
            
            // Edit Attachment Label
            $('#attachment-edit-cancel').onclick = () => { DOMElements.attachmentEditModal.classList.add('hidden'); setModalOpen(false); };
            DOMElements.attachmentEditForm.onsubmit = (e) => {
                e.preventDefault();
                const id = DOMElements.attachmentEditForm['edit-item-id'].value;
                const type = DOMElements.attachmentEditForm['edit-item-type'].value;
                const idx = DOMElements.attachmentEditForm['edit-att-index'].value;
                const item = (type==='project'?currentState.projects:currentState.incidents).find(i=>i.id===id);
                item.attachments[idx].label = DOMElements.attachmentEditInput.value;
                saveToLocalStorage(type==='project'?STORAGE_KEYS.PROJECTS:STORAGE_KEYS.INCIDENTS, type==='project'?currentState.projects:currentState.incidents);
                DOMElements.attachmentEditModal.classList.add('hidden'); setModalOpen(false);
                renderDetail(id, type);
                showToast('Label updated.', 'info');
            };
            
            // Import Options
            $('#import-mode-overwrite').onclick = () => finalizeImport('overwrite');
            $('#import-mode-merge').onclick = () => finalizeImport('merge');
            $('#import-mode-cancel').onclick = () => {
                window.importedData = null;
                DOMElements.importOptionsModal.classList.add('hidden');
                setModalOpen(false);
                showToast('Import cancelled.', 'info');
            };

            // Mobile FAB
            DOMElements.fabMainBtn.onclick = () => {
                if(DOMElements.dashboardContainer.classList.contains('mobile-detail-view')) setMobileView('list');
                else DOMElements.fabActions.classList.toggle('hidden');
            };
            DOMElements.fabListBtn.onclick = () => setMobileView('list');
            DOMElements.fabScratchpadBtn.onclick = () => { openScratchpad(); DOMElements.fabActions.classList.add('hidden'); };
            DOMElements.fabNotesBtn.onclick = () => { if(currentState.selectedItem) { setMobileView('detail'); DOMElements.fabActions.classList.add('hidden'); } };
            DOMElements.fabSdapBtn.onclick = () => { openSdapModal(); DOMElements.fabActions.classList.add('hidden'); };

            // Hotkeys
            document.addEventListener('keydown', (e) => {
                if(e.ctrlKey && e.key === '`') { e.preventDefault(); DOMElements.scratchpadModal.classList.contains('hidden') ? openScratchpad() : DOMElements.scratchpadCloseBtn.click(); }
            });

            // Resize Listener for Mobile View
            window.addEventListener('resize', () => {
                const mobile = window.innerWidth <= 768;
                if (mobile !== currentState.isMobile) {
                    currentState.isMobile = mobile;
                    if(!mobile) {
                        DOMElements.dashboardContainer.classList.remove('mobile-list-view', 'mobile-detail-view');
                        DOMElements.fabActions.classList.add('hidden');
                    } else {
                        setMobileView('list');
                    }
                }
            });

            if(currentState.isMobile) setMobileView('list');
            
            console.log("%c WEYU-UTANI CORP ", "background: #000; color: #FFF000; font-size: 20px; font-weight: bold;");
            console.log("SYSTEM: SRC-D2 // PEACE_OPERATOR");
            console.log("STATUS: READY");
        };

        document.addEventListener('DOMContentLoaded', initApp);

/* ======================================================
   MODULE: WHITE HAT SURVIVAL TOOLKIT [CONSOLIDATED v2]
   ====================================================== */

/* --- 1. FAB INJECTION (SURVIVAL TOOLKIT - TACTICAL UPDATE) --- */
const injectSurvivalMenu = () => {
    if (document.getElementById('survival-fab')) return;

    const fabHTML = `
    <div id="survival-fab" class="fixed bottom-4 left-4 z-40 flex flex-col-reverse gap-3 items-center">
        <button id="sv-toggle-btn" class="w-12 h-12 rounded-full bg-[#050A19] border-2 border-cyan-500 text-cyan-500 hover:bg-cyan-900/50 hover:text-white shadow-[0_0_15px_rgba(0,255,255,0.2)] flex items-center justify-center transition-all z-50">
            <span style="font-size: 1.5rem; font-weight: bold;">ᛉ</span>
        </button>
        
        <div id="sv-menu-items" class="hidden flex flex-col-reverse gap-3">
            <button id="sv-btn-peace" class="w-10 h-10 rounded-full bg-slate-800 border border-purple-500 text-purple-400 hover:bg-purple-900 hover:text-white shadow-lg flex items-center justify-center" title="Peace Operator: Live Mix">ᚫ</button>
            <button id="sv-btn-hw" class="w-10 h-10 rounded-full bg-slate-800 border border-green-500 text-green-400 hover:bg-green-900 hover:text-white shadow-lg flex items-center justify-center" title="Hardware Audit">ᛰ</button>
            <button id="sv-btn-net" class="w-10 h-10 rounded-full bg-slate-800 border border-cyan-500 text-cyan-400 hover:bg-cyan-900 hover:text-white shadow-lg flex items-center justify-center" title="Net Sentry">⌖</button>
        </div>
    </div>`;

    document.body.insertAdjacentHTML('beforeend', fabHTML);

    const toggleBtn = document.getElementById('sv-toggle-btn');
    const menuItems = document.getElementById('sv-menu-items');
    
    toggleBtn.onclick = () => {
        menuItems.classList.toggle('hidden');
        toggleBtn.classList.toggle('bg-slate-800');
    };

    document.getElementById('sv-btn-net').onclick = openNetModal;
    document.getElementById('sv-btn-hw').onclick = openHardwareModal;
    document.getElementById('sv-btn-peace').onclick = initPeaceOperator; 
};

/* --- NET SENTRY V2.2: INTEGRATED DIAGNOSTICS & LOGGING --- */
let sentryState = {
    active: false,
    dataLoop: null,
    animLoop: null,
    prevLatency: 0,
    currentLatency: 0,
    jitter: 0,
    stabilityScore: 100,
    seq: 0,
    history: [], 
    ctx: null,
    bufferCtx: null,
    width: 0,
    height: 0
};

const openNetModal = () => {
    if (!document.getElementById('modal-net')) {
        const html = `
        <div id="modal-net" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md transition-opacity">
            <div class="modal-content relative bg-dark-navy p-6 w-11/12 md:w-2/3 rounded-lg glow-border-cyan flex flex-col shadow-[0_0_50px_rgba(0,255,255,0.15)]">
                <div class="flex justify-between items-center mb-4 border-b border-cyan-500 pb-2 pr-10">
                    <div class="flex items-center gap-3">
                        <h2 class="text-2xl font-['Michroma'] neon-cyan glow-text-cyan">NET SENTRY > V2.2</h2>
                        <span id="net-status-badge" class="px-2 py-0.5 text-[10px] bg-cyan-900 text-cyan-300 rounded border border-cyan-500 animate-pulse">ACTIVE</span>
                    </div>
                </div>
                <button id="net-close" class="absolute top-5 right-5 text-red-500 rune-close text-2xl font-bold cursor-pointer bg-transparent border-none outline-none z-[90]" title="Terminate Sentry">✖</button>
                <div class="relative w-full h-64 mb-4 bg-black border-2 border-dashed border-cyan-500/50 rounded-lg overflow-hidden">
                    <canvas id="sentry-canvas" class="block w-full h-full opacity-90"></canvas>
                    <div class="absolute inset-0 pointer-events-none bg-[linear-gradient(rgba(18,16,16,0)_50%,rgba(0,0,0,0.25)_50%),linear-gradient(90deg,rgba(255,0,0,0.06),rgba(0,255,0,0.02),rgba(0,0,255,0.06))] z-10 bg-[length:100%_2px,3px_100%]"></div>
                    <div class="absolute top-3 right-4 flex flex-col items-end pointer-events-none z-20">
                        <div id="disp-latency" class="text-4xl font-['Michroma'] text-cyan-400 drop-shadow-[0_0_10px_rgba(0,255,255,0.8)]">0 ms</div>
                        <div id="disp-jitter" class="text-xs font-mono text-cyan-600 mt-1 tracking-widest">JITTER: 0ms</div>
                        <div id="disp-stab" class="text-xs font-mono text-green-400 mt-1 tracking-widest drop-shadow-md">INTEGRITY: 100%</div>
                    </div>
                    <div id="net-warning" class="hidden absolute inset-0 flex items-center justify-center bg-black/80 z-30">
                        <span class="text-red-500 font-['Michroma'] text-2xl tracking-[0.5em] animate-pulse drop-shadow-[0_0_15px_red]">SIGNAL_LOST</span>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="md:col-span-2 flex flex-col gap-2">
                        <div class="flex justify-between items-center">
                            <span class="text-[10px] text-cyan-500 font-mono uppercase tracking-widest">PACKET_LOG</span>
                            <div class="flex gap-2">
                                <button id="btn-fetch-ip" class="glyph-btn text-xs text-cyan-400 border border-cyan-500/30 rounded px-2 hover:bg-cyan-900/50">[ SCAN IP ]</button>
                                <button id="btn-export-log" class="glyph-btn text-xs text-yellow-400 border border-yellow-500/30 rounded px-2 hover:bg-yellow-900/50">[ ⇩ SAVE LOG ]</button>
                            </div>
                        </div>
                        <textarea id="sentry-log" class="text-viewer w-full h-24 p-2 text-[10px] rounded resize-none border border-cyan-500/30 focus:border-cyan-500 outline-none" readonly></textarea>
                    </div>
                    <div class="flex flex-col gap-2">
                        <span class="text-[10px] text-cyan-500 font-mono uppercase tracking-widest">CIDR_CALC</span>
                        <div class="flex gap-1">
                            <input type="text" id="subnet-input" class="bg-mid-blue border border-cyan-500/50 text-cyan-100 text-xs p-2 w-full font-mono rounded focus:shadow-[0_0_10px_rgba(0,255,255,0.3)] outline-none" placeholder="10.0.0.1/24">
                            <button id="btn-calc" class="p-2 bg-cyan-900 hover:bg-cyan-700 text-white text-xs rounded border border-cyan-500 transition-all">></button>
                        </div>
                        <div id="subnet-result" class="flex-grow bg-black/40 border border-cyan-500/30 p-2 rounded flex flex-col justify-center gap-1 text-[10px] font-mono text-cyan-300">
                            <span class="opacity-50">_READY</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
        document.getElementById('net-close').onclick = closeSentry;
        document.getElementById('btn-calc').onclick = calculateSubnet;
        document.getElementById('btn-fetch-ip').onclick = fetchPublicIP;
        document.getElementById('btn-export-log').onclick = exportSentryLog;
    }

    const modal = document.getElementById('modal-net');
    modal.classList.remove('hidden');
    
    const cvs = document.getElementById('sentry-canvas');
    const container = cvs.parentElement;
    cvs.width = container.clientWidth;
    cvs.height = container.clientHeight;
    
    sentryState.ctx = cvs.getContext('2d');
    sentryState.width = cvs.width;
    sentryState.height = cvs.height;
    
    const buffer = document.createElement('canvas');
    buffer.width = sentryState.width;
    buffer.height = sentryState.height;
    sentryState.bufferCtx = buffer.getContext('2d');
    
    sentryState.active = true;
    sentryState.history = new Array(Math.floor(sentryState.width / 2)).fill(0); 
    sentryState.stabilityScore = 100;
    
    logToSentry("SYSTEM", "NET_SENTRY_V2.2_INITIATED");
    startSentryEngine();
};

const closeSentry = () => {
    sentryState.active = false;
    document.getElementById('modal-net').classList.add('hidden');
    if (sentryState.dataLoop) clearInterval(sentryState.dataLoop);
    if (sentryState.animLoop) cancelAnimationFrame(sentryState.animLoop);
};

const startSentryEngine = () => {
    if (sentryState.dataLoop) clearInterval(sentryState.dataLoop);
    
    sentryState.dataLoop = setInterval(async () => {
        if (!sentryState.active) return;
        const start = performance.now();
        let isLoss = false;
        try {
            const target = window.location.href.split('#')[0] + '?t=' + start;
            await fetch(target, { method: 'HEAD', cache: 'no-store' });
            const end = performance.now();
            const rawLatency = end - start;
            
            sentryState.jitter = Math.abs(rawLatency - sentryState.prevLatency);
            sentryState.prevLatency = sentryState.currentLatency;
            sentryState.currentLatency = rawLatency;

            if (sentryState.jitter > 50 || rawLatency > 500) {
                sentryState.stabilityScore = Math.max(0, sentryState.stabilityScore - 10);
            } else {
                sentryState.stabilityScore = Math.min(100, sentryState.stabilityScore + 2);
            }
        } catch (e) {
            isLoss = true;
            sentryState.currentLatency = 0;
            sentryState.stabilityScore = Math.max(0, sentryState.stabilityScore - 20);
        }
        updateStatsUI(isLoss);
        const status = isLoss ? "LOSS" : (sentryState.jitter > 20 ? "UNSTABLE" : "OK");
        logToSentry(sentryState.seq++, `PING:${Math.round(sentryState.currentLatency)}ms JIT:${Math.round(sentryState.jitter)}ms [${status}]`);
    }, 1000);

    const drawFrame = () => {
        if (!sentryState.active) return;
        const { ctx, bufferCtx, width, height, currentLatency, jitter } = sentryState;

        bufferCtx.globalCompositeOperation = 'copy';
        bufferCtx.drawImage(bufferCtx.canvas, 0, 0, width, height - 1, 0, 1, width, height - 1);
        bufferCtx.globalCompositeOperation = 'source-over';

        let r=0, g=255, b=255; 
        if (currentLatency > 100) { r=0; g=255; b=100; }
        if (currentLatency > 300) { r=255; g=255; b=0; }
        if (currentLatency > 500) { r=255; g=50; b=0; }

        const alpha = Math.min(1, Math.max(0.1, currentLatency / 400));
        
        bufferCtx.fillStyle = `rgba(${r}, ${g}, ${b}, ${alpha})`;
        for(let x=0; x<width; x+=4) {
            if(Math.random() > 0.5) bufferCtx.fillRect(x, 0, 3, 1);
        }

        ctx.fillStyle = '#000000';
        ctx.fillRect(0, 0, width, height);
        ctx.drawImage(bufferCtx.canvas, 0, 0);

        const jitterHeight = Math.min(height/2, jitter * 2);
        sentryState.history.push(jitterHeight);
        if (sentryState.history.length > width / 2) sentryState.history.shift();

        ctx.beginPath();
        ctx.strokeStyle = jitter > 20 ? '#ff00ff' : 'rgba(34, 211, 238, 0.9)'; 
        ctx.shadowBlur = 10;
        ctx.shadowColor = ctx.strokeStyle; 
        ctx.lineWidth = 2;
        
        let xPos = width;
        for (let i = sentryState.history.length - 1; i >= 0; i--) {
            const hVal = sentryState.history[i];
            const yPos = (height / 2) - hVal;
            if (i === sentryState.history.length - 1) ctx.moveTo(xPos, yPos);
            else ctx.lineTo(xPos, yPos);
            xPos -= 2;
        }
        ctx.stroke();
        ctx.shadowBlur = 0;

        ctx.strokeStyle = 'rgba(34, 211, 238, 0.2)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(0, height/2);
        ctx.lineTo(width, height/2);
        ctx.stroke();

        sentryState.animLoop = requestAnimationFrame(drawFrame);
    };

    drawFrame();
};

const updateStatsUI = (isLoss) => {
    const latEl = document.getElementById('disp-latency');
    const jitEl = document.getElementById('disp-jitter');
    const stabEl = document.getElementById('disp-stab');
    const warn = document.getElementById('net-warning');

    if (isLoss) {
        warn.classList.remove('hidden');
        latEl.innerText = "---";
        latEl.style.color = "#ef4444";
    } else {
        warn.classList.add('hidden');
        latEl.innerText = Math.round(sentryState.currentLatency) + " ms";
        if(sentryState.currentLatency < 100) latEl.style.color = "#22d3ee"; 
        else if(sentryState.currentLatency < 300) latEl.style.color = "#facc15"; 
        else latEl.style.color = "#ef4444"; 
    }

    jitEl.innerText = `JITTER: ${Math.round(sentryState.jitter)}ms`;
    stabEl.innerText = `INTEGRITY: ${Math.round(sentryState.stabilityScore)}%`;
    stabEl.className = `text-xs font-mono mt-1 tracking-widest drop-shadow-md ${sentryState.stabilityScore > 80 ? 'text-green-400' : 'text-red-400'}`;
};

const logToSentry = (seq, msg) => {
    const el = document.getElementById('sentry-log');
    if (!el) return;
    const time = new Date().toLocaleTimeString().split(' ')[0];
    const line = `[${String(seq).padStart(4,'0')}] ${time} > ${msg}\n`;
    el.value += line;
    el.scrollTop = el.scrollHeight;
};

const exportSentryLog = () => {
    const logContent = document.getElementById('sentry-log').value;
    if(!logContent) return;
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `NET_SENTRY_LOG_${timestamp}.txt`;
    const blob = new Blob([
        "--- NET SENTRY V2.2 TELEMETRY LOG ---\n" +
        "--- EVIDENCE EXPORT ---\n\n" + 
        logContent
    ], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
};

const calculateSubnet = () => {
    const input = document.getElementById('subnet-input').value.trim();
    const resEl = document.getElementById('subnet-result');
    const ip2long = (ip) => ip.split('.').reduce((acc, octet) => (acc << 8) + parseInt(octet, 10), 0) >>> 0;
    const long2ip = (long) => [(long >>> 24) & 0xFF, (long >>> 16) & 0xFF, (long >>> 8) & 0xFF, long & 0xFF].join('.');

    try {
        if (!input.includes('/')) throw new Error("Missing CIDR");
        const [ipStr, cidrStr] = input.split('/');
        const cidr = parseInt(cidrStr, 10);
        if (cidr < 0 || cidr > 32) throw new Error("Invalid CIDR");
        const ipLong = ip2long(ipStr);
        const maskLong = (0xFFFFFFFF << (32 - cidr)) >>> 0;
        const netLong = (ipLong & maskLong) >>> 0;
        const broadLong = (netLong | (~maskLong >>> 0)) >>> 0;
        const hosts = Math.pow(2, 32 - cidr) - 2;

        resEl.innerHTML = `
            <span>NET:  ${long2ip(netLong)}</span>
            <span>MASK: ${long2ip(maskLong)}</span>
            <span>BRD:  ${long2ip(broadLong)}</span>
            <span class="text-white">HOSTS: ${hosts > 0 ? hosts.toLocaleString() : 0}</span>
        `;
    } catch (e) {
        resEl.innerHTML = `<span class="text-red-400">ERR: ${e.message}</span>`;
    }
};

const fetchPublicIP = async () => {
    const btn = document.getElementById('btn-fetch-ip');
    const originalText = btn.innerText;
    btn.innerText = "SCANNING...";
    btn.disabled = true;
    try {
        const response = await fetch('https://api.ipify.org?format=json');
        const data = await response.json();
        logToSentry("INFO", `PUBLIC_IP: ${data.ip}`);
    } catch (e) {
        logToSentry("ERR", "IP_FETCH_BLOCKED");
    } finally {
        btn.innerText = originalText;
        btn.disabled = false;
    }
};

/* --- 3. MODAL B: HARDWARE AUDIT (BLE + OPSEC) --- */
const openHardwareModal = () => {
    if (!document.getElementById('modal-hw')) {
        const html = `
        <div id="modal-hw" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md">
            <div class="modal-content bg-dark-navy p-4 w-full max-w-md rounded-lg border-2 border-green-500 shadow-[0_0_30px_rgba(0,255,0,0.15)] flex flex-col">
                <div class="flex justify-between items-center mb-3 border-b border-green-900 pb-2">
                    <h2 class="text-xl font-['Michroma'] neon-green">DEVICE AUDIT</h2>
                    <button id="hw-close" class="text-green-500 hover:text-white font-bold text-xl">✖</button>
                </div>
                <div class="bg-black/40 p-2 border border-green-500/30 rounded mb-3">
                    <div class="flex justify-between mb-2">
                        <span class="text-xs text-green-400 font-bold">BLE SPECTRUM</span>
                        <button id="ble-scan-btn" class="text-[10px] bg-green-900 text-white px-2 rounded hover:bg-green-700">SCAN</button>
                    </div>
                    <div id="ble-out" class="h-24 overflow-y-auto font-mono text-[10px] text-gray-400">Waiting for trigger...</div>
                </div>
                <div class="grid grid-cols-2 gap-2 mb-3">
                    <div class="bg-black/40 p-2 border border-green-500/30 rounded">
                        <div class="text-[10px] text-gray-500">BATTERY</div>
                        <div id="hw-batt" class="text-lg font-mono text-white">--%</div>
                    </div>
                    <div class="bg-black/40 p-2 border border-green-500/30 rounded">
                        <div class="text-[10px] text-gray-500">CORES</div>
                        <div id="hw-cpu" class="text-lg font-mono text-white">--</div>
                    </div>
                </div>
                <div class="bg-black/40 p-2 border border-green-500/30 rounded">
                     <div class="text-[10px] text-gray-500 mb-1">FINGERPRINT / UA LEAK</div>
                     <div id="hw-ua" class="text-[10px] font-mono text-green-300 break-all leading-tight">...</div>
                </div>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
        document.getElementById('hw-close').onclick = () => document.getElementById('modal-hw').classList.add('hidden');
        document.getElementById('ble-scan-btn').onclick = runBLE;
        if(navigator.getBattery) {
            navigator.getBattery().then(b => {
                const update = () => {
                    const el = document.getElementById('hw-batt');
                    if(el) el.innerText = Math.round(b.level*100) + '% ' + (b.charging?'⚡':'');
                };
                b.addEventListener('levelchange', update);
                b._manualUpdate = update;
            });
        }
    }
    document.getElementById('modal-hw').classList.remove('hidden');
    document.getElementById('hw-cpu').innerText = navigator.hardwareConcurrency || '?';
    document.getElementById('hw-ua').innerText = navigator.userAgent;
    if(navigator.getBattery) {
        navigator.getBattery().then(b => {
            if(b._manualUpdate) b._manualUpdate();
            else {
                 const el = document.getElementById('hw-batt');
                 if(el) el.innerText = Math.round(b.level*100) + '% ' + (b.charging?'⚡':'');
            }
        });
    }
};

const runBLE = async () => {
    const out = document.getElementById('ble-out');
    out.innerHTML = '<span class="text-yellow-400 animate-pulse">INITIALIZING SCAN...</span>';
    if (!navigator.bluetooth) {
        out.innerHTML = '<span class="text-red-500">ERR: WebBluetooth API missing.</span><br><span class="text-gray-500 text-[9px]">Reason: Browser unsupported or running from file://. (Requires HTTPS/Localhost)</span>';
        setTimeout(() => {
            out.innerHTML += '<br><br><span class="text-cyan-500">--- SIMULATION MODE ---</span><br>Found: <span class="text-white">Unknown_Tracker_1X</span> (RSSI: -45)<br>Found: <span class="text-white">Smart_Tag_04</span> (RSSI: -82)';
        }, 1500);
        return;
    }
    try {
        const device = await navigator.bluetooth.requestDevice({ acceptAllDevices: true });
        out.innerHTML = `<span class="text-green-400">CONNECTED:</span> <span class="text-white">${device.name || 'Unnamed Device'}</span><br><span class="text-gray-500">ID: ${device.id}</span>`;
    } catch(e) {
        out.innerHTML = `<span class="text-red-400">SCAN_ABORT:</span> ${e.message}`;
    }
};

/* --- 4. MODAL C: SDAP-7 LOGGER (W-Y EVANSCIRA) --- */
let sdapLogs = {};
let activeSdapLog = 'worklog';
const SDAP_STORAGE_KEY = 'sdap_project_logs';
const SDAP_INITIAL = {
    worklog: "[16:25:00] Initializing SDAP-7 Manual Ingestion Module.\n[16:25:01] Select a tab, paste AI output, and click 'Commit Log Entry'.",
    decision: "[16:25:10] DECISION LOG: Initial state is 'Analyze', awaiting first codebase report.",
    task: "[16:25:20] TASK LOG: T-001: Initial codebase analysis; T-002: Define final data schema."
};

const openSdapModal = () => {
    if (!document.getElementById('modal-sdap')) {
        const html = `
        <div id="modal-sdap" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/90 backdrop-blur-md">
            <div class="bg-dark-navy p-4 w-full max-w-2xl rounded-lg border-2 border-yellow-500 shadow-[0_0_30px_rgba(255,215,0,0.15)] flex flex-col max-h-[90vh]">
                <div class="flex justify-between items-center mb-3 border-b border-yellow-900 pb-2">
                    <h2 class="text-xl font-['Michroma'] text-yellow-400" style="text-shadow: 0 0 10px rgba(255,215,0,0.5);">W-Y EVANSCIRA // SDAP-7</h2>
                    <button id="sdap-close" class="text-yellow-500 hover:text-white font-bold text-xl">✖</button>
                </div>
                <div class="flex border-b border-yellow-500/30 mb-2">
                    <button id="sdap-tab-worklog" class="px-4 py-2 text-xs font-bold text-cyan-400 border-r border-yellow-500/30 hover:bg-yellow-900/20 transition-colors">WORKLOG</button>
                    <button id="sdap-tab-decision" class="px-4 py-2 text-xs font-bold text-green-400 border-r border-yellow-500/30 hover:bg-yellow-900/20 transition-colors">DECISIONS</button>
                    <button id="sdap-tab-task" class="px-4 py-2 text-xs font-bold text-yellow-400 hover:bg-yellow-900/20 transition-colors">TASKS</button>
                </div>
                <div id="sdap-log-display" class="w-full h-64 bg-black/50 p-3 font-mono text-xs text-gray-300 border border-yellow-500/30 resize-none overflow-y-auto mb-4 whitespace-pre-wrap"></div>
                <textarea id="sdap-input" class="w-full h-20 bg-black/50 p-2 font-mono text-xs text-white border border-gray-600 focus:border-yellow-500 focus:outline-none mb-3" placeholder="PASTE AGENTIC AI OUTPUT HERE..."></textarea>
                <div class="flex gap-2 mb-3">
                    <button id="sdap-commit-btn" class="flex-grow bg-yellow-700 hover:bg-yellow-600 text-white text-xs font-bold py-2 px-4 rounded border border-yellow-500 shadow-[0_0_10px_rgba(255,215,0,0.2)]">COMMIT ENTRY</button>
                    <button id="sdap-export-btn" class="bg-slate-700 hover:bg-slate-600 text-white text-xs font-bold py-2 px-4 rounded border border-gray-500">EXPORT .TXT</button>
                </div>
                <div id="sdap-emergency-area">
                    <button id="sdap-emergency-btn" class="w-full bg-red-900/50 hover:bg-red-800 text-red-400 text-[10px] font-bold py-1 rounded border border-red-500/50 tracking-widest transition-all">!!! EMERGENCY SHUTDOWN: CLEAR LOGS !!!</button>
                </div>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
        document.getElementById('sdap-close').onclick = () => document.getElementById('modal-sdap').classList.add('hidden');
        document.getElementById('sdap-tab-worklog').onclick = () => switchSdapLog('worklog');
        document.getElementById('sdap-tab-decision').onclick = () => switchSdapLog('decision');
        document.getElementById('sdap-tab-task').onclick = () => switchSdapLog('task');
        document.getElementById('sdap-commit-btn').onclick = commitSdapEntry;
        document.getElementById('sdap-export-btn').onclick = exportSdapLogs;
        document.getElementById('sdap-emergency-btn').onclick = promptSdapEmergency;
        loadSdapLogs();
    }
    document.getElementById('modal-sdap').classList.remove('hidden');
    switchSdapLog('worklog');
};

const loadSdapLogs = () => {
    const stored = localStorage.getItem(SDAP_STORAGE_KEY);
    if (stored) {
        try {
            sdapLogs = JSON.parse(stored);
            if (!sdapLogs.worklog) sdapLogs.worklog = SDAP_INITIAL.worklog;
            if (!sdapLogs.decision) sdapLogs.decision = SDAP_INITIAL.decision;
            if (!sdapLogs.task) sdapLogs.task = SDAP_INITIAL.task;
        } catch (e) { sdapLogs = SDAP_INITIAL; }
    } else {
        sdapLogs = SDAP_INITIAL;
    }
};

const saveSdapLogs = () => localStorage.setItem(SDAP_STORAGE_KEY, JSON.stringify(sdapLogs));

const switchSdapLog = (type) => {
    activeSdapLog = type;
    ['worklog', 'decision', 'task'].forEach(t => {
        const btn = document.getElementById(`sdap-tab-${t}`);
        if(t === type) btn.classList.add('bg-yellow-900/40', 'text-white');
        else btn.classList.remove('bg-yellow-900/40', 'text-white');
    });
    const display = document.getElementById('sdap-log-display');
    display.textContent = sdapLogs[type];
    display.scrollTop = display.scrollHeight;
};

const commitSdapEntry = () => {
    const input = document.getElementById('sdap-input');
    const val = input.value.trim();
    if(!val) return;
    const ts = new Date().toLocaleTimeString('en-US', { hour12: false });
    const prefix = `\n\n--- ${ts} --- AGENT INGESTED (${activeSdapLog.toUpperCase()}) ---\n`;
    sdapLogs[activeSdapLog] += prefix + val;
    saveSdapLogs();
    input.value = '';
    switchSdapLog(activeSdapLog); 
};

const exportSdapLogs = () => {
    const ts = new Date().toISOString().slice(0, 10);
    const content = 
        `W-Y EVANSCIRA LABS SDAP-7 EXPORT - ${ts}\n` +
        `======================================================\n\n` +
        `--- WORKLOG ---\n${sdapLogs.worklog}\n\n` +
        `--- DECISIONS ---\n${sdapLogs.decision}\n\n` +
        `--- TASKS ---\n${sdapLogs.task}\n\n` +
        `======================================================\n` +
        `END OF TRANSMISSION`;
    const blob = new Blob([content], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `SDAP-7_Log_${ts}.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
};

const promptSdapEmergency = () => {
    const area = document.getElementById('sdap-emergency-area');
    area.innerHTML = `
        <div class="flex justify-between items-center bg-red-900/80 p-2 rounded border border-red-500 animate-pulse">
            <span class="text-white text-xs font-bold">CONFIRM RESET?</span>
            <div class="flex gap-2">
                <button id="sdap-confirm-reset" class="bg-red-600 hover:bg-red-500 text-white text-xs px-2 py-1 rounded">YES</button>
                <button id="sdap-cancel-reset" class="bg-slate-700 hover:bg-slate-600 text-white text-xs px-2 py-1 rounded">NO</button>
            </div>
        </div>`;
    document.getElementById('sdap-confirm-reset').onclick = () => {
        localStorage.removeItem(SDAP_STORAGE_KEY);
        sdapLogs = SDAP_INITIAL;
        saveSdapLogs();
        switchSdapLog('worklog');
        restoreSdapEmergency();
    };
    document.getElementById('sdap-cancel-reset').onclick = restoreSdapEmergency;
};

const restoreSdapEmergency = () => {
    const area = document.getElementById('sdap-emergency-area');
    area.innerHTML = `<button id="sdap-emergency-btn" class="w-full bg-red-900/50 hover:bg-red-800 text-red-400 text-[10px] font-bold py-1 rounded border border-red-500/50 tracking-widest transition-all">!!! EMERGENCY SHUTDOWN: CLEAR LOGS !!!</button>`;
    document.getElementById('sdap-emergency-btn').onclick = promptSdapEmergency;
};

if (document.readyState === 'loading') document.addEventListener('DOMContentLoaded', injectSurvivalMenu);
else injectSurvivalMenu();

/* --- MODULE: PEACE OPERATOR (HYBRID FIELD EDITION v3.7) --- */
let peaceCtx, peaceAnalyser, peaceSource, peaceAnimId, peaceGain;
let peaceStream = null; 
let peaceMode = 'ENV_ANALYZER'; 

// ISO 1/3 Octave Bands
const ISO_BANDS = [20, 25, 31.5, 40, 50, 63, 80, 100, 125, 160, 200, 250, 315, 400, 500, 630, 800, 1000, 1250, 1600, 2000, 2500, 3150, 4000, 5000, 6300, 8000, 10000, 12500, 16000, 20000];
let eqGains = new Array(31).fill(0); // -12 to +12 dB

let audioState = {
    peakHold: -100, peakDecay: 0, noiseFloor: -60, dominantHz: 0, spectrogram: [], 
    volumeHistory: new Array(100).fill(0), lastUiUpdate: 0, sinePhase: 0, inputGain: 1.0,
    calibrationFrames: 0, prevBins: new Uint8Array(1024), lastToastTime: 0,
    spectralFlux: 0, centroidHz: 0, hnr: 0, perceivedNote: "--", dominantNote: "--",
    lastValidNote: "--", lastValidDom: "--", smoothedCentroidY: 0,
    threatLevel: 0.0, psychState: 'CALM', noteHistory: [], 
    zcr: 0, pitchBuffer: [], socialState: 'NEUTRAL', flirtProb: 0.0, laughterSustain: 0, 
    silenceTimer: 0, avgPitchBaseline: 0, intentLabel: "WAITING", reactionLabel: "MONITORING", correctionAlert: "",
    dbSmoothed: -100
};

const initPeaceOperator = async () => {
    if (!document.getElementById('modal-peace')) {
        const html = `
        <div id="modal-peace" class="hidden fixed inset-0 z-[100] flex items-center justify-center bg-black/95 backdrop-blur-md transition-all duration-500">
            <div class="relative bg-[#0b0f19] w-full h-full md:w-[95vw] md:h-[90vh] md:rounded-xl md:border-2 md:border-cyan-500 md:shadow-[0_0_50px_rgba(0,255,255,0.1)] flex flex-col overflow-hidden">
                <div class="flex justify-between items-center bg-black/90 p-2 border-b border-cyan-500/30 shrink-0 z-20">
                    <div class="flex items-center gap-2">
                        <div id="peace-led" class="w-2 h-2 rounded-full bg-gray-600 shadow-[0_0_5px_currentColor] transition-colors duration-300"></div>
                        <h2 class="text-sm md:text-lg font-['Michroma'] text-white tracking-widest truncate">SRC-D2 <span class="text-cyan-500">HYBRID_DSP</span></h2>
                    </div>
                    <div class="flex bg-gray-900 rounded border border-gray-700 p-0.5">
                        <button id="mode-btn-env" class="px-3 py-1 text-[9px] md:text-[10px] font-bold font-['Michroma'] rounded bg-cyan-900 text-white border border-cyan-500 transition-all">ENG</button>
                        <button id="mode-btn-peace" class="px-3 py-1 text-[9px] md:text-[10px] font-bold font-['Michroma'] rounded text-gray-500 hover:text-white transition-all">PSY</button>
                    </div>
                    <button id="peace-close-btn" class="w-8 h-8 flex items-center justify-center text-red-500 border border-red-500/30 rounded hover:bg-red-900/20">✕</button>
                </div>
                <div class="flex-grow flex flex-col md:flex-row overflow-hidden relative">
                    <div class="order-1 md:order-2 flex-grow relative bg-black h-[45vh] md:h-full w-full">
                        <canvas id="peace-canvas" class="w-full h-full block"></canvas>
                        <div class="absolute top-2 right-2 flex flex-col items-end pointer-events-none">
                            <div id="overlay-mode-txt" class="text-lg font-['Michroma'] text-cyan-500/20">ANALYZER</div>
                            <div id="overlay-sub-txt" class="text-[9px] font-mono text-cyan-500/40">RTA_ACTIVE</div>
                        </div>
                    </div>
                    <div class="order-2 md:order-1 w-full md:w-80 bg-[#050810] border-t md:border-t-0 md:border-r border-cyan-900/50 flex p-3 gap-3 shrink-0 h-[55vh] md:h-full z-10 shadow-[0_-10px_20px_rgba(0,0,0,0.5)]">
                        <div class="w-12 md:w-16 bg-black/60 border border-gray-800 rounded-lg p-1 flex flex-col items-center justify-between relative">
                            <div class="text-[8px] text-gray-500 font-mono mb-1">PK</div>
                            <div id="fader-peak-txt" class="text-[9px] text-red-500 font-mono font-bold mb-1">-inf</div>
                            <div class="relative flex-grow w-4 md:w-6 bg-gray-900 rounded-full overflow-hidden border border-gray-800">
                                <div id="fader-bar" class="absolute bottom-0 left-0 w-full bg-gradient-to-t from-green-500 via-yellow-400 to-red-500 transition-all duration-75" style="height: 0%"></div>
                                <div id="fader-peak-line" class="absolute left-0 w-full h-[2px] bg-white shadow-[0_0_5px_white] transition-all duration-100" style="bottom: 0%"></div>
                            </div>
                            <div class="text-[8px] text-gray-500 font-mono mt-1">RMS</div>
                        </div>
                        <div class="flex-grow flex flex-col gap-2 overflow-y-auto">
                            <div class="bg-black/40 border border-cyan-900/50 p-2 rounded flex justify-between items-center">
                                <div>
                                    <div class="text-[9px] text-gray-500 uppercase">Loudness</div>
                                    <div id="data-db" class="text-xl font-mono text-cyan-400">-inf <span class="text-xs text-gray-600">dB</span></div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[9px] text-gray-500 uppercase">Flux</div>
                                    <div id="data-flux" class="text-xl font-mono text-purple-400">0.0</div>
                                </div>
                            </div>
                            <div id="panel-env-mode" class="flex flex-col gap-2">
                                <div class="bg-black/40 border border-gray-800 p-2 rounded">
                                    <div class="flex justify-between">
                                        <div>
                                            <div class="text-[8px] text-gray-500 uppercase">Dominant</div>
                                            <div id="data-dom-note" class="text-lg font-mono text-yellow-400">--</div>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-[8px] text-gray-500 uppercase">Perceived</div>
                                            <div id="data-note" class="text-lg font-mono text-cyan-400">--</div>
                                        </div>
                                    </div>
                                    <div class="mt-1 pt-1 border-t border-gray-800/50 flex justify-between text-[8px] font-mono">
                                        <span class="text-gray-600">ZCR: <span id="val-zcr" class="text-gray-400">0.00</span></span>
                                        <span class="text-gray-600">HNR: <span id="val-hnr" class="text-gray-400">0%</span></span>
                                    </div>
                                </div>
                                <div class="bg-black/40 border border-gray-800 p-2 rounded">
                                    <div class="flex justify-between items-center mb-1">
                                        <div class="text-[9px] text-gray-500">31-BAND EQ SIMULATOR</div>
                                        <div class="flex gap-1">
                                            <button id="eq-auto-btn" class="text-[8px] bg-cyan-900 px-2 py-0.5 rounded hover:bg-cyan-700 text-white border border-cyan-500/50">AUTO EQ</button>
                                            <button id="eq-reset-btn" class="text-[8px] bg-gray-700 px-2 py-0.5 rounded hover:bg-gray-600 text-white border border-gray-500/50">FLATTEN</button>
                                        </div>
                                    </div>
                                    <div id="eq-container" class="flex flex-row h-32 gap-px bg-black border border-gray-700 p-1 relative"></div>
                                    <div class="text-[8px] text-gray-500 text-center mt-1">INTERACTIVE: DRAG FADERS TO CORRECT</div>
                                </div>
                                <div class="bg-black/40 border border-gray-800 p-2 rounded">
                                    <div class="flex justify-between items-center mb-1">
                                        <div class="text-[9px] text-gray-500">INPUT TRIM</div>
                                        <div id="gain-val" class="text-[9px] text-cyan-400">100%</div>
                                    </div>
                                    <input type="range" id="gain-slider" min="0" max="2" step="0.1" value="1" class="w-full h-1 bg-gray-700 rounded-lg appearance-none cursor-pointer mb-2">
                                    <div id="data-res" class="text-xs text-green-500 font-mono text-center">SPECTRUM CLEAR</div>
                                </div>
                            </div>
                            <div id="panel-peace-mode" class="hidden flex flex-col gap-2 h-full">
                                <div class="bg-black/40 border border-gray-800 p-2 rounded">
                                    <div class="flex justify-between items-end mb-1">
                                        <div class="text-[9px] text-red-400">THREAT LEVEL</div>
                                        <div id="threat-pct" class="text-[9px] text-gray-500">0%</div>
                                    </div>
                                    <div class="w-full h-1 bg-gray-800 rounded mb-2 overflow-hidden">
                                        <div id="threat-bar" class="h-full bg-cyan-500 w-0 transition-all duration-75"></div>
                                    </div>
                                    <div id="data-state" class="text-lg font-['Michroma'] text-white">CALM</div>
                                    <div id="data-state-sub" class="text-[9px] text-gray-500 mt-1">MONITORING...</div>
                                </div>
                                <div class="bg-black/60 border border-purple-500/30 p-2 rounded relative overflow-hidden flex-grow">
                                    <div class="text-[8px] text-purple-400 tracking-widest mb-1">SOCIAL INTENT</div>
                                    <div id="soc-intent" class="text-sm font-['Michroma'] text-white truncate mb-1">NEUTRAL</div>
                                    <div id="soc-reaction" class="text-[9px] font-mono text-cyan-300 mb-2">LISTENING...</div>
                                    <div id="soc-alert" class="text-[9px] font-bold text-red-500 bg-red-900/10 border border-red-900/30 p-1 rounded text-center hidden mb-2">
                                        BREATHE. DO NOT FILL SILENCE.
                                    </div>
                                    <div class="flex justify-between items-end mb-1">
                                        <div class="text-[8px] text-pink-400">VIBE CHECK</div>
                                        <div id="soc-flirt-pct" class="text-[8px] text-white">0%</div>
                                    </div>
                                    <div class="w-full h-1 bg-gray-800 rounded overflow-hidden">
                                        <div id="soc-flirt-bar" class="h-full bg-gradient-to-r from-purple-500 to-pink-500 w-0 transition-all duration-300"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>`;
        document.body.insertAdjacentHTML('beforeend', html);
        document.getElementById('peace-close-btn').onclick = closePeaceOperator;
        document.getElementById('mode-btn-env').onclick = () => setPeaceMode('ENV_ANALYZER');
        document.getElementById('mode-btn-peace').onclick = () => setPeaceMode('PEACE_KEEPER');
        document.getElementById('eq-reset-btn').onclick = () => { eqGains.fill(0); renderEQ(); };
        document.getElementById('eq-auto-btn').onclick = runAutoEQ;
        
        const gainSlider = document.getElementById('gain-slider');
        const gainVal = document.getElementById('gain-val');
        gainSlider.oninput = (e) => {
            const val = parseFloat(e.target.value);
            const logVal = val * val; 
            audioState.inputGain = logVal;
            if(peaceGain) peaceGain.gain.value = logVal;
            gainVal.innerText = Math.round(val * 100) + "%";
        };
        window.addEventListener('resize', () => {
            const canvas = document.getElementById('peace-canvas');
            if(canvas) {
                canvas.width = canvas.clientWidth;
                canvas.height = canvas.clientHeight;
                audioState.spectrogram = [];
            }
        });
        renderEQ();
    }

    const modal = document.getElementById('modal-peace');
    modal.classList.remove('hidden');

    try {
        peaceStream = await navigator.mediaDevices.getUserMedia({ audio: true });
        peaceCtx = new (window.AudioContext || window.webkitAudioContext)();
        if (peaceCtx.state === 'suspended') await peaceCtx.resume();

        peaceAnalyser = peaceCtx.createAnalyser();
        peaceGain = peaceCtx.createGain();
        peaceSource = peaceCtx.createMediaStreamSource(peaceStream);
        
        peaceSource.connect(peaceGain);
        peaceGain.connect(peaceAnalyser);
        peaceGain.gain.value = audioState.inputGain;
        
        peaceAnalyser.fftSize = 2048; 
        peaceAnalyser.smoothingTimeConstant = 0.8; 

        const bufferLength = peaceAnalyser.frequencyBinCount; 
        const dataArrayFreq = new Uint8Array(bufferLength); 
        const dataArrayTime = new Float32Array(bufferLength);
        
        const canvas = document.getElementById('peace-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = canvas.clientWidth;
        canvas.height = canvas.clientHeight;

        const ui = {
            db: document.getElementById('data-db'), flux: document.getElementById('data-flux'),
            peakTxt: document.getElementById('fader-peak-txt'), bar: document.getElementById('fader-bar'),
            peakLine: document.getElementById('fader-peak-line'), domNote: document.getElementById('data-dom-note'),
            note: document.getElementById('data-note'), res: document.getElementById('data-res'),
            led: document.getElementById('peace-led'), zcr: document.getElementById('val-zcr'),
            hnr: document.getElementById('val-hnr'), state: document.getElementById('data-state'),
            stateSub: document.getElementById('data-state-sub'), threatBar: document.getElementById('threat-bar'),
            threatPct: document.getElementById('threat-pct'), intent: document.getElementById('soc-intent'),
            reaction: document.getElementById('soc-reaction'), alert: document.getElementById('soc-alert'),
            flirtBar: document.getElementById('soc-flirt-bar'), flirtPct: document.getElementById('soc-flirt-pct')
        };

        const analyze = () => {
            peaceAnimId = requestAnimationFrame(analyze);
            peaceAnalyser.getByteFrequencyData(dataArrayFreq);
            peaceAnalyser.getFloatTimeDomainData(dataArrayTime);

            let sumSquares = 0, peakInstant = 0, zcrCount = 0;
            for(let i = 0; i < bufferLength; i++) {
                const amp = Math.abs(dataArrayTime[i]);
                sumSquares += amp * amp;
                if (amp > peakInstant) peakInstant = amp;
                if (i > 0) {
                    if ((dataArrayTime[i] >= 0 && dataArrayTime[i-1] < 0) || (dataArrayTime[i] < 0 && dataArrayTime[i-1] >= 0)) zcrCount++;
                }
            }
            
            audioState.zcr = zcrCount / bufferLength; 
            const rms = Math.sqrt(sumSquares / bufferLength);
            let instantDb = 20 * Math.log10(rms);
            if (!isFinite(instantDb)) instantDb = -100;

            // SMOOTHING LOGIC
            audioState.dbSmoothed = (audioState.dbSmoothed * 0.8) + (instantDb * 0.2);
            let db = audioState.dbSmoothed;

            let dbPeak = 20 * Math.log10(peakInstant);
            if (!isFinite(dbPeak)) dbPeak = -100;
            if (dbPeak > audioState.peakHold) {
                audioState.peakHold = dbPeak;
                audioState.peakDecay = 60; 
            } else {
                if (audioState.peakDecay > 0) audioState.peakDecay--;
                else audioState.peakHold -= 0.2; 
            }

            // UPDATE EQ SIMULATOR
            updateEQ(dataArrayFreq, bufferLength);

            // GHOST MODE: BATTERY SAVER RTA (3rd Octave) + GUARDIAN LOGIC
            if (document.body.classList.contains('ghost-mode')) {
                // GUARDIAN LOGIC: Check for critical events
                const isLoud = db > -10; // Gamer shouting threshold
                const isHighFreq = audioState.centroidHz > 2000;
                const isBaby = isLoud && isHighFreq && audioState.hnr < 0.8; // Rough heuristic for crying

                if (isLoud || isBaby) {
                    // RED FLASH
                    ctx.fillStyle = '#8b0000'; 
                    ctx.fillRect(0, 0, canvas.width, canvas.height);
                    
                    // Warning Text
                    ctx.fillStyle = 'white';
                    ctx.font = 'bold 20px Michroma';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(isBaby ? "CRITICAL: HIGH FREQ" : "VOLUME ALERT", canvas.width/2, canvas.height/2);
                    
                    // Still update UI text so meter works
                    const now = Date.now();
                    if (now - audioState.lastUiUpdate > 50) {
                        const faderPct = Math.min(100, Math.max(0, ((db + 60) / 60) * 100));
                        const peakPct = Math.min(100, Math.max(0, ((audioState.peakHold + 60) / 60) * 100));
                        ui.db.innerText = db.toFixed(1);
                        ui.bar.style.height = faderPct + "%";
                        ui.peakLine.style.bottom = peakPct + "%";
                        ui.peakTxt.innerText = audioState.peakHold <= -60 ? "-inf" : audioState.peakHold.toFixed(1);
                        audioState.lastUiUpdate = now;
                    }
                    return; 
                }

                // Normal Ghost Mode Rendering (Grey Bars)
                ctx.fillStyle = '#000';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                const bands = 31;
                const barW = canvas.width / bands;
                
                for(let b=0; b<bands; b++) {
                    const startBin = Math.floor(Math.pow(2, b/3) * 2); 
                    const endBin = Math.floor(Math.pow(2, (b+1)/3) * 2);
                    let bandSum = 0;
                    let count = 0;
                    
                    for(let k=startBin; k<endBin && k<bufferLength; k++) {
                        bandSum += dataArrayFreq[k];
                        count++;
                    }
                    const avg = count > 0 ? bandSum/count : 0;
                    const h = (avg / 255) * canvas.height;
                    
                    if (avg > 200) ctx.fillStyle = '#8b0000'; // Critical Red
                    else ctx.fillStyle = '#333'; // Dim Grey
                    
                    ctx.fillRect(b * barW, canvas.height - h, barW - 1, h);
                }
                
                const now = Date.now();
                if (now - audioState.lastUiUpdate > 50) {
                    const faderPct = Math.min(100, Math.max(0, ((db + 60) / 60) * 100));
                    const peakPct = Math.min(100, Math.max(0, ((audioState.peakHold + 60) / 60) * 100));
                    ui.db.innerText = db.toFixed(1);
                    ui.bar.style.height = faderPct + "%";
                    ui.peakLine.style.bottom = peakPct + "%";
                    ui.peakTxt.innerText = audioState.peakHold <= -60 ? "-inf" : audioState.peakHold.toFixed(1);
                    audioState.lastUiUpdate = now;
                }
                return; 
            }

            let maxVal = 0, maxIndex = 0, totalAmp = 0, centroidSum = 0, lowFreqEnergy = 0; 
            const nyquist = peaceCtx.sampleRate / 2;
            const startIndex = Math.floor(40 / (peaceCtx.sampleRate / peaceAnalyser.fftSize));

            for (let i = startIndex; i < bufferLength; i++) {
                const amp = dataArrayFreq[i];
                totalAmp += amp;
                centroidSum += amp * (i * nyquist / bufferLength);
                if (amp > maxVal) { maxVal = amp; maxIndex = i; }
                if (i < 20) lowFreqEnergy += amp;
            }

            audioState.centroidHz = totalAmp > 0 ? centroidSum / totalAmp : 0;
            const f0 = (maxIndex / bufferLength) * nyquist;
            audioState.dominantHz = f0;

            let flux = 0;
            for (let i = 0; i < bufferLength; i++) {
                let diff = dataArrayFreq[i] - audioState.prevBins[i];
                if (diff > 0) {
                    const weight = i > (bufferLength / 2) ? 1.5 : 1.0;
                    flux += diff * weight;
                }
                audioState.prevBins[i] = dataArrayFreq[i];
            }
            audioState.spectralFlux = flux / bufferLength;

            if (db > -50) {
                audioState.pitchBuffer.push(f0);
                if (audioState.pitchBuffer.length > 180) audioState.pitchBuffer.shift();
                audioState.avgPitchBaseline = (audioState.avgPitchBaseline * 0.995) + (f0 * 0.005);
            }

            let localSum = 0, count = 0;
            for (let i = Math.max(0, maxIndex - 5); i < Math.min(bufferLength, maxIndex + 5); i++) {
                localSum += dataArrayFreq[i];
                count++;
            }
            let avgLocal = localSum / count;
            audioState.hnr = avgLocal > 0 ? maxVal / avgLocal : 0; 

            if (audioState.centroidHz > f0 * 1.8) audioState.perceivedNote = getNote(audioState.centroidHz);
            else audioState.perceivedNote = getNote(f0);
            audioState.dominantNote = getNote(f0);

            if (peaceMode === 'PEACE_KEEPER') {
                analyzeThreatLogic(db, f0);
                analyzeSocialIntent(db, lowFreqEnergy, f0);
            }

            // Global Volume Guidance (Normal Mode - PSY ONLY)
            if (peaceMode === 'PEACE_KEEPER' && db > -10) {
                triggerToast("⚠️ OPERATOR ALERT: LOWER YOUR VOICE", "warning");
            }

            const now = Date.now();
            if (now - audioState.lastUiUpdate > 50) { 
                const faderPct = Math.min(100, Math.max(0, ((db + 60) / 60) * 100));
                const peakPct = Math.min(100, Math.max(0, ((audioState.peakHold + 60) / 60) * 100));
                
                ui.db.innerText = db.toFixed(1);
                ui.flux.innerText = audioState.spectralFlux.toFixed(1);
                ui.bar.style.height = faderPct + "%";
                ui.peakLine.style.bottom = peakPct + "%";
                ui.peakTxt.innerText = audioState.peakHold <= -60 ? "-inf" : audioState.peakHold.toFixed(1);
                
                if (db > -40) {
                    ui.domNote.innerText = audioState.dominantNote;
                    ui.note.innerText = audioState.perceivedNote;
                    ui.zcr.innerText = audioState.zcr.toFixed(2);
                    ui.hnr.innerText = Math.round(audioState.hnr * 10) + "%";
                }

                if (peaceMode === 'ENV_ANALYZER') {
                    if (maxVal > 220 && db < -10) {
                        if (audioState.centroidHz > 4000) {
                            ui.res.innerText = `SIBILANCE: ${Math.round(audioState.centroidHz)}Hz`;
                            ui.res.className = "text-xs text-cyan-400 font-mono text-center";
                        } else {
                            ui.res.innerText = `RINGING: ${Math.round(audioState.centroidHz)}Hz`;
                            ui.res.className = "text-xs text-red-400 font-mono animate-pulse text-center";
                        }
                    } else {
                        ui.res.innerText = "SPECTRUM CLEAR";
                        ui.res.className = "text-xs text-green-500 font-mono text-center";
                    }
                } else {
                    ui.threatBar.style.width = (audioState.threatLevel * 100) + "%";
                    ui.threatPct.innerText = Math.round(audioState.threatLevel * 100) + "%";
                    
                    let stateColor = "text-white";
                    let ledColor = "#4b5563";

                    if (audioState.threatLevel > 0.8) {
                        ui.state.innerText = "AGGRESSIVE"; stateColor = "text-red-500"; ledColor = "#ef4444";
                        ui.threatBar.className = "h-full bg-red-500 w-0 transition-all duration-75";
                    } else if (audioState.threatLevel > 0.4) {
                        ui.state.innerText = "PROJECTING"; stateColor = "text-yellow-400"; ledColor = "#eab308";
                        ui.threatBar.className = "h-full bg-yellow-400 w-0 transition-all duration-75";
                    } else {
                        ui.state.innerText = "CALM"; stateColor = "text-cyan-400"; ledColor = "#06b6d4";
                        ui.threatBar.className = "h-full bg-cyan-500 w-0 transition-all duration-75";
                    }
                    ui.state.className = `text-lg font-['Michroma'] ${stateColor}`;
                    ui.led.style.backgroundColor = ledColor;

                    if (audioState.threatLevel > 0.5) {
                        ui.intent.innerText = "HOSTILITY";
                        ui.intent.className = "text-sm font-['Michroma'] text-red-500 truncate mb-1";
                        ui.reaction.innerText = "DE-ESCALATE IMMEDIATELY";
                        ui.alert.classList.add('hidden');
                    } else {
                        ui.intent.innerText = audioState.intentLabel;
                        ui.reaction.innerText = audioState.reactionLabel;
                        if (audioState.intentLabel === "GENUINE_LAUGHTER") ui.intent.className = "text-sm font-['Michroma'] text-yellow-400 truncate mb-1 animate-pulse";
                        else if (audioState.intentLabel === "INTIMATE") ui.intent.className = "text-sm font-['Michroma'] text-pink-400 truncate mb-1";
                        else ui.intent.className = "text-sm font-['Michroma'] text-white truncate mb-1";

                        if (audioState.correctionAlert) {
                            ui.alert.innerText = audioState.correctionAlert;
                            ui.alert.classList.remove('hidden');
                        } else {
                            ui.alert.classList.add('hidden');
                        }
                    }
                    ui.flirtPct.innerText = Math.round(audioState.flirtProb * 100) + "%";
                    ui.flirtBar.style.width = (audioState.flirtProb * 100) + "%";
                }
                audioState.lastUiUpdate = now;
            }

            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            const canvasElement = document.getElementById('peace-canvas');
            if (audioState.threatLevel > 0.6) {
                canvasElement.style.filter = `contrast(150%) brightness(80%) saturate(200%) sepia(100%) hue-rotate(-50deg)`; 
                canvasElement.style.boxShadow = `0 0 20px rgba(239, 68, 68, 0.4)`;
            } else if (audioState.socialState === 'GENUINE_LAUGHTER') {
                canvasElement.style.filter = `contrast(120%) brightness(120%) saturate(200%) sepia(50%) hue-rotate(40deg)`;
                canvasElement.style.boxShadow = `none`;
            } else if (audioState.socialState === 'INTIMATE') {
                canvasElement.style.filter = `contrast(110%) brightness(90%) saturate(150%) hue-rotate(280deg)`;
                canvasElement.style.boxShadow = `none`;
            } else {
                canvasElement.style.filter = `contrast(100%) brightness(100%) saturate(100%)`;
                canvasElement.style.boxShadow = `none`;
            }

            if (peaceMode === 'ENV_ANALYZER') {
                drawEngineerMode(ctx, canvas, dataArrayFreq, bufferLength, audioState.dominantHz);
            } else {
                drawPeaceMode(ctx, canvas, db);
            }
        };
        analyze();
    } catch (err) {
        console.error(err);
        alert("Microphone access denied.");
        closePeaceOperator();
    }
};

const renderEQ = () => {
    const container = document.getElementById('eq-container');
    if(!container) return;
    container.innerHTML = '';
    
    eqGains.forEach((gain, i) => {
        const band = document.createElement('div');
        band.className = 'eq-band flex-1 h-full relative group';
        
        // LED
        const led = document.createElement('div');
        led.id = `eq-led-${i}`;
        led.className = 'eq-led absolute top-0';
        
        // Signal Bar (RTA)
        const signal = document.createElement('div');
        signal.id = `eq-signal-${i}`;
        signal.className = 'eq-signal-bar';
        
        // Fader Cap
        const cap = document.createElement('div');
        cap.id = `eq-cap-${i}`;
        cap.className = 'eq-fader-cap';
        const pct = 50 - (gain * 4); 
        cap.style.top = `${pct}%`;
        
        band.appendChild(led);
        band.appendChild(signal);
        band.appendChild(cap);
        
        // Interaction
        const updateGain = (e) => {
            const rect = band.getBoundingClientRect();
            const y = e.clientY - rect.top;
            const h = rect.height;
            const norm = 1 - (y / h); // 0 to 1
            const newGain = (norm * 24) - 12;
            eqGains[i] = Math.max(-12, Math.min(12, newGain));
            cap.style.top = `${(y/h)*100}%`;
        };

        band.addEventListener('mousedown', (e) => {
            updateGain(e);
            const moveHandler = (ev) => updateGain(ev);
            const upHandler = () => {
                window.removeEventListener('mousemove', moveHandler);
                window.removeEventListener('mouseup', upHandler);
            };
            window.addEventListener('mousemove', moveHandler);
            window.addEventListener('mouseup', upHandler);
        });
        
        // Touch support
        band.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevent scrolling
            const touch = e.touches[0];
            const rect = band.getBoundingClientRect();
            const y = touch.clientY - rect.top;
            const h = rect.height;
            const norm = 1 - (y / h);
            const newGain = (norm * 24) - 12;
            eqGains[i] = Math.max(-12, Math.min(12, newGain));
            cap.style.top = `${(y/h)*100}%`;
        });
        
        container.appendChild(band);
    });
};

const updateEQ = (dataFreq, bufferLen) => {
    // Map FFT to 31 bands
    for(let b=0; b<31; b++) {
        const startBin = Math.floor(Math.pow(2, b/3) * 2); 
        const endBin = Math.floor(Math.pow(2, (b+1)/3) * 2);
        let bandSum = 0;
        let count = 0;
        for(let k=startBin; k<endBin && k<bufferLen; k++) {
            bandSum += dataFreq[k];
            count++;
        }
        const avg = count > 0 ? bandSum/count : 0;
        
        // Update Signal Bar
        const signalBar = document.getElementById(`eq-signal-${b}`);
        if(signalBar) {
            const hPct = (avg / 255) * 100;
            signalBar.style.height = `${hPct}%`;
        }

        // Simulation Logic: Input + Fader Gain
        const simulatedLevel = avg + (eqGains[b] * 4); // Scale gain effect
        
        const led = document.getElementById(`eq-led-${b}`);
        if(led) {
            if (simulatedLevel > 220) {
                led.className = 'eq-led active-red';
            } else if (eqGains[b] < -2 && avg > 100) {
                led.className = 'eq-led active-green';
            } else {
                led.className = 'eq-led';
            }
        }
    }
};

const runAutoEQ = () => {
    // Simple Auto-EQ Algorithm: Cut peaks
    const container = document.getElementById('eq-container');
    if(!container) return;
    
    // We need access to the current levels, which are calculated in updateEQ loop.
    // Since we don't store them globally, we'll do a quick visual check or rely on the last frame.
    // Better approach: Reset gains based on last known high levels.
    
    // For this simulation, we will iterate through the DOM elements to find "Red" LEDs and cut them.
    for(let b=0; b<31; b++) {
        const led = document.getElementById(`eq-led-${b}`);
        const cap = document.getElementById(`eq-cap-${b}`);
        if(led && led.classList.contains('active-red')) {
            // Cut this freq
            eqGains[b] = Math.max(-12, eqGains[b] - 3); // Cut by 3dB steps
            // Update visual cap
            const pct = 50 - (eqGains[b] * 4); 
            if(cap) cap.style.top = `${pct}%`;
        }
    }
    showToast("AUTO-EQ: PEAKS SUPPRESSED", "success");
};

const triggerToast = (msg, type) => {
    const now = Date.now();
    if (now - audioState.lastToastTime > 4000) {
        if(typeof showToast === 'function') showToast(msg, type);
        else console.log(`[TOAST]: ${msg}`);
        audioState.lastToastTime = now;
    }
};

const analyzeThreatLogic = (db, f0) => {
    let threatDelta = -0.005; 
    const isVowelStable = audioState.hnr > 1.5 && audioState.spectralFlux < 2.0;
    const isLowFreq = f0 < 250;

    if (db > -25) {
        const highPerceptualPitch = audioState.centroidHz > 1200;
        const isNoisy = audioState.hnr < 1.2;
        if (highPerceptualPitch && isNoisy) threatDelta = 0.04;
        else if (isLowFreq && isVowelStable) threatDelta = -0.02; 
        else if (db > -10) threatDelta = 0.01;
    }

    audioState.noteHistory.push(audioState.perceivedNote);
    if (audioState.noteHistory.length > 10) audioState.noteHistory.shift();
    
    const uniqueNotes = new Set(audioState.noteHistory).size;
    const sub = document.getElementById('data-state-sub');
    
    if (uniqueNotes > 5 && audioState.hnr > 1.5 && db > -40) {
        if(sub) {
            sub.innerText = "INTERFERENCE DETECTED";
            sub.className = "text-[9px] text-yellow-500 mt-1 animate-pulse";
        }
    } else {
        if(sub) {
            sub.className = "text-[9px] text-gray-500 mt-1";
            if(sub.innerText === "INTERFERENCE DETECTED") sub.innerText = "MONITORING...";
        }
    }

    audioState.threatLevel = Math.max(0, Math.min(1, audioState.threatLevel + threatDelta));
    if (audioState.threatLevel > 0.8) triggerToast("⚠️ HOSTILITY DETECTED: DE-ESCALATE", "error");
};

const analyzeSocialIntent = (db, lowFreqEnergy, f0) => {
    let pitchStdDev = 0;
    if (audioState.pitchBuffer.length > 2) {
        const mean = audioState.pitchBuffer.reduce((a, b) => a + b, 0) / audioState.pitchBuffer.length;
        const variance = audioState.pitchBuffer.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / audioState.pitchBuffer.length;
        pitchStdDev = Math.sqrt(variance);
    }

    if (db < -50) audioState.silenceTimer += 16; 
    else audioState.silenceTimer = 0;

    const isHighZCR = audioState.zcr > 0.15; 
    
    if (db > -20 && isHighZCR && lowFreqEnergy > 500) {
        audioState.laughterSustain++;
        if (audioState.laughterSustain > 120) { 
            audioState.socialState = 'GENUINE_LAUGHTER';
            audioState.intentLabel = "PURE_JOY";
            audioState.reactionLabel = "GENUINE LAUGHTER";
            audioState.correctionAlert = "";
        }
    } else if (db > -35 && isHighZCR && lowFreqEnergy < 200) {
        if (audioState.laughterSustain < 60 && audioState.laughterSustain > 5) {
            audioState.socialState = 'NERVOUS_LAUGHTER';
            audioState.intentLabel = "NERVOUS_DISCHARGE";
            audioState.reactionLabel = "ANXIETY LEAK";
            audioState.correctionAlert = "BREATHE. SLOW DOWN.";
        }
        audioState.laughterSustain++;
    } else {
        audioState.laughterSustain = Math.max(0, audioState.laughterSustain - 2);
    }

    if (pitchStdDev > 50 && audioState.silenceTimer > 200 && audioState.silenceTimer < 1000) {
        audioState.socialState = 'HUMOR';
        audioState.intentLabel = "INTENT_HUMOR";
        audioState.reactionLabel = "PERFORMATIVE TIMING";
    }

    const isLowPitch = f0 < (audioState.avgPitchBaseline * 0.9);
    const isBreathy = audioState.spectralFlux > 3.0;
    const isLowVol = db > -45 && db < -20;

    if (isLowPitch && isBreathy && isLowVol) {
        audioState.socialState = 'INTIMATE';
        audioState.intentLabel = "STATE_INTIMATE";
        audioState.reactionLabel = "PROXIMITY DETECTED";
        audioState.flirtProb = Math.min(1.0, audioState.flirtProb + 0.01);
    } else {
        audioState.flirtProb = Math.max(0, audioState.flirtProb - 0.002);
    }

    if (audioState.laughterSustain === 0 && audioState.flirtProb < 0.2 && pitchStdDev < 20) {
        audioState.socialState = 'NEUTRAL';
        audioState.intentLabel = "NEUTRAL_SIGNAL";
        audioState.reactionLabel = "PASSIVE MONITORING";
        audioState.correctionAlert = "";
    }
};

const drawEngineerMode = (ctx, canvas, dataFreq, len, domHz) => {
    const w = canvas.width;
    const h = canvas.height;
    const drawLimit = Math.floor(len * 0.7); 

    const specHeight = h * 0.6;
    const rowCanvas = document.createElement('canvas');
    rowCanvas.width = w;
    rowCanvas.height = 1;
    const rowCtx = rowCanvas.getContext('2d');
    
    for(let i=0; i<w; i+=4) {
        const binIdx = Math.floor((i / w) * (len/2)); 
        const val = dataFreq[binIdx];
        if(val > 5) {
            let color = `rgba(0,0,0,0)`;
            if (val < 50) color = `rgba(0, 0, ${val*5}, 0.5)`; 
            else if (val < 100) color = `rgba(${val}, 0, ${val*2}, 0.6)`; 
            else if (val < 180) color = `rgba(${val}, 0, 0, 0.8)`; 
            else if (val < 220) color = `rgba(255, ${val}, 0, 0.9)`; 
            else color = `rgba(255, 255, 255, 1)`; 
            rowCtx.fillStyle = color;
            rowCtx.fillRect(i, 0, 4, 1);
        }
    }
    
    audioState.spectrogram.unshift(rowCanvas);
    if(audioState.spectrogram.length > specHeight) audioState.spectrogram.pop();
    audioState.spectrogram.forEach((row, idx) => ctx.drawImage(row, 0, idx));

    const rtaTop = specHeight;
    const rtaHeight = h - specHeight;
    ctx.fillStyle = 'rgba(10, 15, 25, 0.9)';
    ctx.fillRect(0, rtaTop, w, rtaHeight);
    ctx.strokeStyle = '#1a2238';
    ctx.beginPath();
    ctx.moveTo(0, rtaTop + rtaHeight*0.5); ctx.lineTo(w, rtaTop + rtaHeight*0.5);
    ctx.stroke();

    const barWidth = w / drawLimit; 
    let x = 0;
    
    for(let i = 0; i < drawLimit; i++) {
        const val = dataFreq[i];
        const barH = (val / 255) * rtaHeight;
        const binHz = i * (peaceCtx.sampleRate / peaceAnalyser.fftSize);
        let hue = (i / drawLimit) * 280;
        if (Math.abs(binHz - domHz) < 50 && val > 100) hue = 0;

        ctx.fillStyle = `hsla(${hue}, 70%, 60%, 0.8)`;
        ctx.fillRect(x, h - barH, barWidth, barH);
        x += barWidth + 0.5;
    }
};

const drawPeaceMode = (ctx, canvas, db) => {
    const w = canvas.width;
    const h = canvas.height;
    const cy = h / 2;
    
    const centroidRatio = Math.min(1, audioState.centroidHz / 5000);
    const targetY = cy - (centroidRatio * h * 0.3) + (h * 0.15); 
    audioState.smoothedCentroidY = (audioState.smoothedCentroidY * 0.95) + (targetY * 0.05);
    const perceptualY = audioState.smoothedCentroidY;

    const normalizedVol = Math.max(0, (db + 60) / 60);
    audioState.volumeHistory.push({vol: normalizedVol, y: perceptualY});
    if(audioState.volumeHistory.length > 60) audioState.volumeHistory.shift();

    ctx.beginPath();
    for (let i = 0; i < audioState.volumeHistory.length; i++) {
        const data = audioState.volumeHistory[audioState.volumeHistory.length - 1 - i];
        const x = w - (i * (w / 60));
        const waveH = data.vol * (h * 0.25);
        ctx.lineTo(x, data.y - waveH);
    }
    for (let i = audioState.volumeHistory.length - 1; i >= 0; i--) {
        const data = audioState.volumeHistory[audioState.volumeHistory.length - 1 - i];
        const x = w - (i * (w / 60));
        const waveH = data.vol * (h * 0.25);
        ctx.lineTo(x, data.y + waveH);
    }

    let color = '75, 85, 99'; 
    if (audioState.threatLevel > 0.6) color = '239, 68, 68'; 
    else if (audioState.socialState === 'GENUINE_LAUGHTER') color = '250, 204, 21'; 
    else if (audioState.socialState === 'INTIMATE') color = '236, 72, 153'; 
    else if (db > -25) color = '34, 211, 238'; 

    ctx.fillStyle = `rgba(${color}, 0.15)`;
    ctx.fill();

    audioState.sinePhase += (0.05 + (audioState.spectralFlux * 0.01)); 
    ctx.beginPath();
    ctx.strokeStyle = `rgb(${color})`;
    ctx.lineWidth = 2 + (audioState.hnr * 2); 

    for (let i = 0; i < w; i += 5) {
        const window = Math.sin((i / w) * Math.PI);
        const noise = (Math.random() - 0.5) * audioState.spectralFlux * 2; 
        const y = perceptualY + Math.sin(i * 0.02 + audioState.sinePhase) * (20 * normalizedVol) * window + noise;
        if (i === 0) ctx.moveTo(i, y);
        else ctx.lineTo(i, y);
    }
    ctx.stroke();
};

const setPeaceMode = (mode) => {
    peaceMode = mode;
    const btnEnv = document.getElementById('mode-btn-env');
    const btnPeace = document.getElementById('mode-btn-peace');
    const panelEnv = document.getElementById('panel-env-mode');
    const panelPeace = document.getElementById('panel-peace-mode');
    const txt = document.getElementById('overlay-mode-txt');
    const sub = document.getElementById('overlay-sub-txt');

    if (mode === 'ENV_ANALYZER') {
        btnEnv.className = "px-3 py-1 text-[9px] md:text-[10px] font-bold font-['Michroma'] rounded bg-cyan-900 text-white border border-cyan-500 transition-all";
        btnPeace.className = "px-3 py-1 text-[9px] md:text-[10px] font-bold font-['Michroma'] rounded text-gray-500 hover:text-white transition-all";
        panelEnv.classList.remove('hidden');
        panelPeace.classList.add('hidden');
        txt.innerText = "ANALYZER";
        txt.className = "text-lg font-['Michroma'] text-cyan-500/20";
        sub.innerText = "RTA_ACTIVE";
    } else {
        btnEnv.className = "px-3 py-1 text-[9px] md:text-[10px] font-bold font-['Michroma'] rounded text-gray-500 hover:text-white transition-all";
        btnPeace.className = "px-3 py-1 text-[9px] md:text-[10px] font-bold font-['Michroma'] rounded bg-purple-900 text-white border border-purple-500 transition-all";
        panelEnv.classList.add('hidden');
        panelPeace.classList.remove('hidden');
        txt.innerText = "HYBRID_DSP";
        txt.className = "text-lg font-['Michroma'] text-purple-500/20";
        sub.innerText = "THREAT + INTENT";
    }
};

const getNote = (freq) => {
    const notes = ["C", "C#", "D", "D#", "E", "F", "F#", "G", "G#", "A", "A#", "B"];
    const c0 = 16.35;
    if(freq < c0) return "";
    const halfSteps = Math.round(12 * Math.log2(freq / c0));
    const octave = Math.floor(halfSteps / 12);
    const noteIndex = halfSteps % 12;
    return notes[noteIndex] + octave;
};

const closePeaceOperator = () => {
    const modal = document.getElementById('modal-peace');
    modal.classList.add('hidden');
    if (peaceAnimId) cancelAnimationFrame(peaceAnimId);
    if (peaceCtx) peaceCtx.close();
    if (peaceStream) {
        peaceStream.getTracks().forEach(t => t.stop());
        peaceStream = null;
    }
};
</script>
</body>
</html>
